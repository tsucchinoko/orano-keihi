# 要件定義書

## 概要

現在の個人用経費・サブスクリプション管理アプリケーションに、Googleログイン機能を追加して複数ユーザーが利用できるようにする。各ユーザーは自分のデータのみにアクセスでき、他のユーザーのデータは見ることができない。

## 用語集

- **System**: 経費・サブスクリプション管理アプリケーション
- **User**: アプリケーションを利用するユーザー
- **Google_Auth**: Google OAuth 2.0認証システム
- **User_Session**: ユーザーのログインセッション
- **User_Data**: ユーザーに紐づく経費、サブスクリプション、レシートデータ

## 要件

### 要件 1: Googleログイン機能

**ユーザーストーリー:** ユーザーとして、Googleアカウントでログインしたい。そうすることで、安全にアプリケーションにアクセスできる。

#### 受入基準

1. WHEN ユーザーがアプリケーションを起動する THEN System SHALL Googleログインページを表示する
2. WHEN ユーザーがGoogleログインボタンをクリックする THEN System SHALL Google_Authの認証フローを開始する
3. WHEN Google_Authが認証を完了する THEN System SHALL ユーザー情報を取得してUser_Sessionを作成する
4. WHEN 認証が失敗する THEN System SHALL エラーメッセージを表示してログイン画面に戻る
5. WHEN ユーザーが既にログイン済みの場合 THEN System SHALL 自動的にメイン画面に遷移する

### 要件 2: ユーザーデータの分離

**ユーザーストーリー:** ユーザーとして、自分のデータのみにアクセスしたい。そうすることで、他のユーザーのプライベートな情報を見ることがない。

#### 受入基準

1. WHEN ユーザーがログインする THEN System SHALL そのユーザーのUser_Dataのみを表示する
2. WHEN ユーザーが経費を作成する THEN System SHALL その経費をログイン中のユーザーに紐づけて保存する
3. WHEN ユーザーがサブスクリプションを作成する THEN System SHALL そのサブスクリプションをログイン中のユーザーに紐づけて保存する
4. WHEN ユーザーがレシートをアップロードする THEN System SHALL そのレシートをログイン中のユーザーに紐づけて保存する
5. WHEN データベースクエリを実行する THEN System SHALL 常にユーザーIDでフィルタリングする

### 要件 3: セッション管理

**ユーザーストーリー:** ユーザーとして、ログイン状態を維持したい。そうすることで、毎回ログインし直す必要がない。

#### 受入基準

1. WHEN ユーザーがログインする THEN System SHALL User_Sessionを安全に保存する
2. WHEN アプリケーションを再起動する THEN System SHALL 有効なUser_Sessionがあれば自動ログインする
3. WHEN セッションが期限切れになる THEN System SHALL ユーザーをログイン画面にリダイレクトする
4. WHEN ユーザーがログアウトボタンをクリックする THEN System SHALL User_Sessionを削除してログイン画面に戻る
5. WHEN セッション情報を保存する THEN System SHALL 暗号化して安全に保存する

### 要件 4: データベーススキーマの拡張

**ユーザーストーリー:** システム管理者として、既存のデータを保持しながらユーザー管理機能を追加したい。そうすることで、データの損失なくマルチユーザー対応できる。

#### 受入基準

1. WHEN データベースマイグレーションを実行する THEN System SHALL 既存のテーブルにuser_idカラムを追加する
2. WHEN 既存データが存在する THEN System SHALL デフォルトユーザーIDを割り当てる
3. WHEN 新しいusersテーブルを作成する THEN System SHALL Google認証情報を安全に保存する
4. WHEN データベースクエリを実行する THEN System SHALL 外部キー制約を適切に設定する
5. WHEN マイグレーションが失敗する THEN System SHALL データベースを元の状態にロールバックする

### 要件 5: ユーザーインターフェースの更新

**ユーザーストーリー:** ユーザーとして、直感的なログイン・ログアウト操作をしたい。そうすることで、スムーズにアプリケーションを利用できる。

#### 受入基準

1. WHEN ログイン画面を表示する THEN System SHALL Googleログインボタンを目立つ位置に配置する
2. WHEN メイン画面を表示する THEN System SHALL ユーザー名とログアウトボタンをヘッダーに表示する
3. WHEN ログイン処理中の場合 THEN System SHALL ローディング表示を行う
4. WHEN 認証エラーが発生する THEN System SHALL 分かりやすいエラーメッセージを表示する
5. WHEN ユーザーがログアウトする THEN System SHALL 確認ダイアログを表示する

### 要件 6: セキュリティとプライバシー

**ユーザーストーリー:** ユーザーとして、自分の認証情報とデータが安全に保護されることを期待する。そうすることで、安心してアプリケーションを利用できる。

#### 受入基準

1. WHEN 認証トークンを保存する THEN System SHALL 暗号化して保存する
2. WHEN APIリクエストを送信する THEN System SHALL 有効な認証トークンを含める
3. WHEN 不正なアクセスを検出する THEN System SHALL アクセスを拒否してログを記録する
4. WHEN ユーザーデータにアクセスする THEN System SHALL 認証済みユーザーのデータのみを返す
5. WHEN セキュリティ設定を管理する THEN System SHALL 最小権限の原則に従う

### 要件 7: 既存機能との互換性

**ユーザーストーリー:** 既存ユーザーとして、これまでのデータと機能を引き続き利用したい。そうすることで、移行による影響を最小限に抑えられる。

#### 受入基準

1. WHEN 既存の経費データにアクセスする THEN System SHALL デフォルトユーザーとして扱う
2. WHEN 既存のサブスクリプションデータにアクセスする THEN System SHALL デフォルトユーザーとして扱う
3. WHEN 既存のレシートデータにアクセスする THEN System SHALL デフォルトユーザーとして扱う
4. WHEN 新機能を追加する THEN System SHALL 既存のAPI互換性を維持する
5. WHEN データ移行を実行する THEN System SHALL バックアップを作成してから実行する