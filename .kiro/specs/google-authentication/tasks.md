# 実装計画: Googleログイン機能

## 概要

既存の個人用経費・サブスクリプション管理アプリケーションにGoogleログイン機能を追加し、マルチユーザー対応を実現する。段階的な実装により、既存データを保持しながら安全に認証機能を導入する。

## タスク

- [x] 1. データベーススキーマの拡張とマイグレーション
  - 新しいusersテーブルとsessionsテーブルを作成
  - 既存テーブル（expenses、subscriptions、receipt_cache）にuser_idカラムを追加
  - 既存データにデフォルトユーザーIDを割り当て
  - マイグレーション処理の実装とロールバック機能
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 1.1 データベースマイグレーションのプロパティテストを作成
  - **プロパティ13: 外部キー制約の適用**
  - **検証対象: 要件 4.4**

- [ ]* 1.2 マイグレーション失敗時のロールバックテストを作成
  - **プロパティ14: マイグレーション失敗時のロールバック**
  - **検証対象: 要件 4.5**

- [ ] 2. Rustバックエンド認証サービスの実装
  - [ ] 2.1 OAuth2クライアントの設定と初期化
    - Google OAuth 2.0設定の追加
    - 環境変数の設定（CLIENT_ID、CLIENT_SECRET）
    - oauth2クレートとtauri-plugin-oauthの統合
    - _要件: 1.2, 1.3_

  - [ ]* 2.2 OAuth認証フローのプロパティテストを作成
    - **プロパティ1: 認証フロー開始**
    - **検証対象: 要件 1.2**

  - [ ] 2.3 認証サービス（AuthService）の実装
    - OAuth認証フローの開始処理
    - 認証コールバックの処理
    - PKCE（Proof Key for Code Exchange）の実装
    - _要件: 1.2, 1.3, 1.4_

  - [ ]* 2.4 認証完了時のセッション作成テストを作成
    - **プロパティ2: 認証完了時のセッション作成**
    - **検証対象: 要件 1.3**

  - [ ]* 2.5 認証失敗時のエラー処理テストを作成
    - **プロパティ3: 認証失敗時のエラー処理**
    - **検証対象: 要件 1.4**

- [ ] 3. セッション管理システムの実装
  - [ ] 3.1 SessionManagerの実装
    - セッション作成、検証、無効化機能
    - セッション暗号化とトークン管理
    - セッション期限管理
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ]* 3.2 セッション管理のプロパティテストを作成
    - **プロパティ8: セッションの安全な管理**
    - **検証対象: 要件 3.1, 3.5**

  - [ ]* 3.3 セッション永続化テストを作成
    - **プロパティ9: セッション永続化**
    - **検証対象: 要件 3.2**

  - [ ]* 3.4 セッション期限管理テストを作成
    - **プロパティ10: セッション期限管理**
    - **検証対象: 要件 3.3**

- [ ] 4. ユーザー管理システムの実装
  - [ ] 4.1 UserRepositoryの実装
    - Googleユーザー情報からのユーザー作成・取得
    - ユーザーデータのCRUD操作
    - ユーザーIDによるデータフィルタリング
    - _要件: 2.1, 2.5, 6.4_

  - [ ]* 4.2 ユーザーデータ分離のプロパティテストを作成
    - **プロパティ5: ユーザーデータの分離**
    - **検証対象: 要件 2.1**

  - [ ]* 4.3 データアクセス制御のプロパティテストを作成
    - **プロパティ7: データアクセス制御**
    - **検証対象: 要件 2.5, 6.4**

- [ ] 5. 既存データアクセス層の更新
  - [ ] 5.1 経費リポジトリの更新
    - user_idフィルタリングの追加
    - 既存データのデフォルトユーザー処理
    - _要件: 2.2, 7.1_

  - [ ] 5.2 サブスクリプションリポジトリの更新
    - user_idフィルタリングの追加
    - 既存データのデフォルトユーザー処理
    - _要件: 2.3, 7.2_

  - [ ] 5.3 レシートリポジトリの更新
    - user_idフィルタリングの追加
    - 既存データのデフォルトユーザー処理
    - _要件: 2.4, 7.3_

  - [ ]* 5.4 データ作成時の所有権設定テストを作成
    - **プロパティ6: データ作成時の所有権設定**
    - **検証対象: 要件 2.2, 2.3, 2.4**

  - [ ]* 5.5 既存データのデフォルトユーザー割り当てテストを作成
    - **プロパティ12: 既存データのデフォルトユーザー割り当て**
    - **検証対象: 要件 7.1, 7.2, 7.3**

- [ ] 6. チェックポイント - バックエンド認証機能の確認
  - すべてのテストが通ることを確認し、質問があれば尋ねる

- [ ] 7. フロントエンド認証システムの実装
  - [ ] 7.1 認証ストア（AuthStore）の実装
    - 認証状態の管理（ユーザー情報、ログイン状態、ローディング状態）
    - ログイン・ログアウト処理
    - セッション状態の確認
    - _要件: 1.5, 3.2, 3.4_

  - [ ]* 7.2 既存セッションの自動ログインテストを作成
    - **プロパティ4: 既存セッションの自動ログイン**
    - **検証対象: 要件 1.5**

  - [ ]* 7.3 ログアウト処理のテストを作成
    - **プロパティ11: ログアウト処理**
    - **検証対象: 要件 3.4**

  - [ ] 7.4 認証ガード（AuthGuard）の実装
    - 認証が必要なページの保護
    - 未認証ユーザーのリダイレクト処理
    - _要件: 1.1, 3.3_

- [ ] 8. ログイン・ログアウトUIの実装
  - [ ] 8.1 ログイン画面の作成
    - Googleログインボタンの配置
    - ローディング状態の表示
    - エラーメッセージの表示
    - _要件: 1.1, 5.1, 5.3, 5.4_

  - [ ]* 8.2 UIコンポーネント表示のテストを作成
    - **プロパティ15: UIコンポーネントの表示**
    - **検証対象: 要件 5.2**

  - [ ]* 8.3 ローディング状態表示のテストを作成
    - **プロパティ16: ローディング状態の表示**
    - **検証対象: 要件 5.3**

  - [ ]* 8.4 エラーメッセージ表示のテストを作成
    - **プロパティ17: エラーメッセージの表示**
    - **検証対象: 要件 5.4**

  - [ ] 8.2 メイン画面のヘッダー更新
    - ユーザー名の表示
    - ログアウトボタンの追加
    - 確認ダイアログの実装
    - _要件: 5.2, 5.5_

  - [ ]* 8.5 ログアウト確認ダイアログのテストを作成
    - **プロパティ18: ログアウト確認ダイアログ**
    - **検証対象: 要件 5.5**

- [ ] 9. セキュリティ機能の実装
  - [ ] 9.1 トークン暗号化の実装
    - 認証トークンの暗号化保存
    - セキュアなトークン管理
    - _要件: 6.1_

  - [ ]* 9.2 認証トークン暗号化のテストを作成
    - **プロパティ19: 認証トークンの暗号化**
    - **検証対象: 要件 6.1**

  - [ ] 9.3 APIリクエスト認証の実装
    - すべてのAPIリクエストに認証トークンを含める
    - 不正アクセスの検出と処理
    - _要件: 6.2, 6.3_

  - [ ]* 9.4 APIリクエスト認証のテストを作成
    - **プロパティ20: APIリクエストの認証**
    - **検証対象: 要件 6.2**

  - [ ]* 9.5 不正アクセス処理のテストを作成
    - **プロパティ21: 不正アクセスの処理**
    - **検証対象: 要件 6.3**

- [ ] 10. データ移行とバックアップ機能
  - [ ] 10.1 データ移行処理の実装
    - 既存データの安全な移行
    - バックアップ作成機能
    - _要件: 7.5_

  - [ ]* 10.2 データ移行バックアップのテストを作成
    - **プロパティ22: データ移行時のバックアップ**
    - **検証対象: 要件 7.5**

- [ ] 11. 統合テストと最終確認
  - [ ] 11.1 エンドツーエンドテストの実装
    - 完全な認証フローのテスト
    - ユーザーデータ分離の確認
    - セッション管理の動作確認

  - [ ]* 11.2 統合テストの作成
    - 認証フロー全体の統合テスト
    - データアクセス制御の統合テスト

- [ ] 12. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があれば尋ねる

## 注意事項

- `*`マークのタスクはオプションで、より迅速なMVPのためにスキップ可能
- 各タスクは特定の要件への追跡可能性のため要件番号を参照
- チェックポイントで段階的な検証を実施
- プロパティテストは普遍的な正当性プロパティを検証
- ユニットテストは特定の例とエッジケースを検証