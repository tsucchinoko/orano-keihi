# 要件定義書

## はじめに

現在、TauriデスクトップアプリケーションはローカルのSQLiteデータベースを使用してユーザー情報、経費、サブスクリプションなどのデータを保存しています。この要件定義書では、ローカルSQLiteからCloudflare D1（クラウドベースのSQLiteデータベース）への移行を定義します。

## 用語集

- **Tauri_App**: デスクトップアプリケーション（Rust + Svelte）
- **API_Server**: Cloudflare Workers上で動作するAPIサーバー（TypeScript + Hono）
- **D1**: Cloudflare D1データベース（クラウドベースのSQLite互換データベース）
- **Repository**: データベースアクセス層（データの読み書きを担当）
- **Migration**: データベーススキーマの変更管理
- **Binding**: Cloudflare Workersでリソースにアクセスするための接続設定

## 要件

### 要件 1: D1データベースのセットアップ

**ユーザーストーリー:** システム管理者として、Cloudflare D1データベースをセットアップしたい。これにより、クラウドベースのデータストレージを利用できるようになる。

#### 受入基準

1. WHEN Cloudflare D1データベースを作成する THEN システムは開発環境用と本番環境用の2つのデータベースを作成する
2. WHEN wrangler.tomlを設定する THEN システムはD1バインディング設定を含める
3. WHEN D1データベースを初期化する THEN システムは必要なテーブル（users, expenses, subscriptions）を作成する

### 要件 2: ユーザーリポジトリの移行

**ユーザーストーリー:** 開発者として、ユーザー情報をD1データベースで管理したい。これにより、複数デバイス間でユーザー情報を同期できるようになる。

#### 受入基準

1. WHEN ユーザーを作成する THEN API_Serverはユーザー情報をD1に保存する
2. WHEN ユーザーIDでユーザーを取得する THEN API_ServerはD1からユーザー情報を取得する
3. WHEN Google IDでユーザーを取得する THEN API_ServerはD1からユーザー情報を取得する
4. WHEN ユーザー情報を更新する THEN API_ServerはD1のユーザー情報を更新する
5. WHEN ユーザーを削除する THEN API_ServerはD1からユーザー情報を削除する
6. WHEN すべてのユーザーを取得する THEN API_ServerはD1からすべてのユーザー情報を取得する

### 要件 3: 経費リポジトリの移行

**ユーザーストーリー:** ユーザーとして、経費情報をクラウドに保存したい。これにより、複数デバイスから経費情報にアクセスできるようになる。

#### 受入基準

1. WHEN 経費を作成する THEN API_Serverは経費情報をD1に保存する
2. WHEN 経費IDで経費を取得する THEN API_ServerはD1から経費情報を取得する
3. WHEN ユーザーIDで経費一覧を取得する THEN API_ServerはD1から該当ユーザーの経費一覧を取得する
4. WHEN 月別で経費一覧を取得する THEN API_ServerはD1から指定月の経費一覧を取得する
5. WHEN 経費情報を更新する THEN API_ServerはD1の経費情報を更新する
6. WHEN 経費を削除する THEN API_ServerはD1から経費情報を削除する

### 要件 4: サブスクリプションリポジトリの移行

**ユーザーストーリー:** ユーザーとして、サブスクリプション情報をクラウドに保存したい。これにより、複数デバイスからサブスクリプション情報にアクセスできるようになる。

#### 受入基準

1. WHEN サブスクリプションを作成する THEN API_Serverはサブスクリプション情報をD1に保存する
2. WHEN サブスクリプションIDでサブスクリプションを取得する THEN API_ServerはD1からサブスクリプション情報を取得する
3. WHEN ユーザーIDでサブスクリプション一覧を取得する THEN API_ServerはD1から該当ユーザーのサブスクリプション一覧を取得する
4. WHEN アクティブなサブスクリプションのみを取得する THEN API_ServerはD1からアクティブなサブスクリプションのみを取得する
5. WHEN サブスクリプション情報を更新する THEN API_ServerはD1のサブスクリプション情報を更新する
6. WHEN サブスクリプションを削除する THEN API_ServerはD1からサブスクリプション情報を削除する
7. WHEN 月額合計を計算する THEN API_ServerはD1からアクティブなサブスクリプションの月額合計を計算する

### 要件 5: APIエンドポイントの実装

**ユーザーストーリー:** Tauriアプリケーション開発者として、D1データベースにアクセスするためのAPIエンドポイントを使用したい。これにより、デスクトップアプリからクラウドデータベースにアクセスできるようになる。

#### 受入基準

1. WHEN ユーザー関連のAPIエンドポイントを呼び出す THEN API_Serverは認証されたユーザーのデータのみを返す
2. WHEN 経費関連のAPIエンドポイントを呼び出す THEN API_Serverは認証されたユーザーの経費データのみを返す
3. WHEN サブスクリプション関連のAPIエンドポイントを呼び出す THEN API_Serverは認証されたユーザーのサブスクリプションデータのみを返す
4. WHEN 認証されていないリクエストを受信する THEN API_Serverは401エラーを返す
5. WHEN 他のユーザーのデータにアクセスしようとする THEN API_Serverは403エラーを返す

### 要件 6: エラーハンドリング

**ユーザーストーリー:** 開発者として、データベース操作のエラーを適切に処理したい。これにより、ユーザーに分かりやすいエラーメッセージを表示できるようになる。

#### 受入基準

1. WHEN D1データベース接続エラーが発生する THEN システムは適切なエラーメッセージをログに記録し、ユーザーに通知する
2. WHEN データが見つからない THEN システムは404エラーを返す
3. WHEN バリデーションエラーが発生する THEN システムは400エラーと詳細なエラーメッセージを返す
4. WHEN データベース制約違反が発生する THEN システムは409エラーを返す
5. WHEN 予期しないエラーが発生する THEN システムは500エラーを返し、詳細をログに記録する

### 要件 7: データマイグレーション

**ユーザーストーリー:** システム管理者として、既存のローカルSQLiteデータをD1に移行したい。これにより、既存ユーザーのデータを失わずにクラウドに移行できる。

#### 受入基準

1. WHEN データマイグレーションツールを実行する THEN システムはローカルSQLiteからすべてのユーザーデータを読み取る
2. WHEN データをD1にアップロードする THEN システムはデータの整合性を保ちながらD1に書き込む
3. WHEN マイグレーション中にエラーが発生する THEN システムはロールバックし、エラーを報告する
4. WHEN マイグレーションが完了する THEN システムはマイグレーション結果のレポートを生成する

### 要件 8: セキュリティ

**ユーザーストーリー:** セキュリティ担当者として、D1データベースへのアクセスを適切に保護したい。これにより、不正アクセスからデータを守ることができる。

#### 受入基準

1. WHEN APIリクエストを受信する THEN システムはJWTトークンで認証を行う
2. WHEN ユーザーが自分のデータにアクセスする THEN システムはアクセスを許可する
3. WHEN ユーザーが他人のデータにアクセスしようとする THEN システムはアクセスを拒否する
4. WHEN SQLインジェクション攻撃を受ける THEN システムはパラメータ化されたクエリで攻撃を防ぐ
5. WHEN 機密情報をログに記録する THEN システムは機密情報をマスクする

### 要件 9: パフォーマンス

**ユーザーストーリー:** ユーザーとして、データベース操作が高速に完了することを期待する。これにより、快適なユーザー体験を提供できる。

#### 受入基準

1. WHEN 単一レコードを取得する THEN システムは100ms以内に応答する
2. WHEN 一覧を取得する THEN システムは500ms以内に応答する
3. WHEN データを作成・更新する THEN システムは200ms以内に応答する
4. WHEN 大量のデータを取得する THEN システムはページネーションを使用する
5. WHEN 頻繁にアクセスされるデータを取得する THEN システムはキャッシュを使用する

### 要件 10: テスト

**ユーザーストーリー:** 開発者として、リポジトリ層の動作を検証するテストを実行したい。これにより、コードの品質を保証できる。

#### 受入基準

1. WHEN ユニットテストを実行する THEN システムはすべてのリポジトリメソッドをテストする
2. WHEN 統合テストを実行する THEN システムはAPIエンドポイントとD1データベースの連携をテストする
3. WHEN テストデータを作成する THEN システムはテスト用のD1データベースを使用する
4. WHEN テストが完了する THEN システムはテストデータをクリーンアップする
5. WHEN テストが失敗する THEN システムは詳細なエラー情報を提供する
