# 実装計画: D1データベース移行

## 概要

TauriデスクトップアプリケーションのローカルSQLiteデータベースをCloudflare D1に移行し、API Server経由でデータにアクセスできるようにします。実装は必要最低限の機能に絞り、段階的に進めます。

## タスク

- [x] 1. D1データベースのセットアップ
  - wrangler.tomlにD1バインディング設定を追加
  - D1データベースを作成（開発環境と本番環境）
  - データベーススキーマを定義するSQLファイルを作成
  - マイグレーションスクリプトを実行してテーブルを作成
  - _要件: 1.1, 1.2, 1.3_

- [x] 2. TypeScript型定義とDTOの作成
  - User, Expense, Subscription型を定義
  - CreateExpenseDto, UpdateExpenseDto, CreateSubscriptionDto, UpdateSubscriptionDto型を定義
  - エラーコードとエラーレスポンス型を定義
  - _要件: 2.1, 3.1, 4.1_

- [x] 3. UserRepositoryの実装
  - [x] 3.1 UserRepositoryクラスを作成
    - D1Databaseをコンストラクタで受け取る
    - findOrCreateUserメソッドを実装
    - getUserByIdメソッドを実装
    - getUserByGoogleIdメソッドを実装
    - updateUserメソッドを実装
    - deleteUserメソッドを実装
    - getAllUsersメソッドを実装
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

  - [ ]* 3.2 UserRepositoryのユニットテストを作成
    - 各メソッドの正常系テスト
    - エラーケースのテスト（存在しないユーザーなど）
    - _要件: 10.1_

- [ ] 4. ExpenseRepositoryの実装
  - [ ] 4.1 ExpenseRepositoryクラスを作成
    - D1Databaseをコンストラクタで受け取る
    - createメソッドを実装
    - findByIdメソッドを実装
    - findAllメソッドを実装（月とカテゴリでフィルタリング）
    - updateメソッドを実装
    - deleteメソッドを実装
    - setReceiptUrlメソッドを実装
    - getReceiptUrlメソッドを実装
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [ ]* 4.2 ExpenseRepositoryのユニットテストを作成
    - 各メソッドの正常系テスト
    - フィルタリング機能のテスト
    - エラーケースのテスト
    - _要件: 10.1_

  - [ ]* 4.3 プロパティテスト: フィルタリングの正確性
    - **プロパティ 7: フィルタリングの正確性**
    - **検証: 要件 3.4**
    - _要件: 10.2_

- [ ] 5. SubscriptionRepositoryの実装
  - [ ] 5.1 SubscriptionRepositoryクラスを作成
    - D1Databaseをコンストラクタで受け取る
    - createメソッドを実装
    - findByIdメソッドを実装
    - findAllメソッドを実装（activeOnlyフィルター）
    - updateメソッドを実装
    - toggleStatusメソッドを実装
    - deleteメソッドを実装
    - calculateMonthlyTotalメソッドを実装
    - setReceiptPathメソッドを実装
    - getReceiptPathメソッドを実装
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

  - [ ]* 5.2 SubscriptionRepositoryのユニットテストを作成
    - 各メソッドの正常系テスト
    - アクティブフィルターのテスト
    - 月額合計計算のテスト
    - エラーケースのテスト
    - _要件: 10.1_

  - [ ]* 5.3 プロパティテスト: アクティブフィルターの正確性
    - **プロパティ 8: アクティブフィルターの正確性**
    - **検証: 要件 4.4**
    - _要件: 10.2_

  - [ ]* 5.4 プロパティテスト: 月額合計の正確性
    - **プロパティ 9: 月額合計の正確性**
    - **検証: 要件 4.7**
    - _要件: 10.2_

- [ ] 6. チェックポイント - リポジトリ層のテスト
  - すべてのリポジトリのユニットテストが通ることを確認
  - 質問があればユーザーに確認

- [ ] 7. ユーザー関連APIエンドポイントの実装
  - [ ] 7.1 GET /api/v1/users/meエンドポイントを実装
    - 認証ミドルウェアを適用
    - 現在のユーザー情報を返す
    - _要件: 5.1_

  - [ ] 7.2 PUT /api/v1/users/meエンドポイントを実装
    - 認証ミドルウェアを適用
    - ユーザー情報を更新
    - _要件: 5.1_

  - [ ] 7.3 DELETE /api/v1/users/meエンドポイントを実装
    - 認証ミドルウェアを適用
    - ユーザーを削除
    - _要件: 5.1_

  - [ ]* 7.4 ユーザーAPIの統合テストを作成
    - 認証フローのテスト
    - CRUD操作のテスト
    - エラーハンドリングのテスト
    - _要件: 10.3_

- [ ] 8. 経費関連APIエンドポイントの実装
  - [ ] 8.1 POST /api/v1/expensesエンドポイントを実装
    - 認証ミドルウェアを適用
    - 経費を作成
    - _要件: 5.2_

  - [ ] 8.2 GET /api/v1/expenses/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - 経費を取得
    - アクセス制御（自分の経費のみ）
    - _要件: 5.2, 5.5_

  - [ ] 8.3 GET /api/v1/expensesエンドポイントを実装
    - 認証ミドルウェアを適用
    - 経費一覧を取得
    - クエリパラメータ（month, category）でフィルタリング
    - _要件: 5.2_

  - [ ] 8.4 PUT /api/v1/expenses/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - 経費を更新
    - アクセス制御（自分の経費のみ）
    - _要件: 5.2, 5.5_

  - [ ] 8.5 DELETE /api/v1/expenses/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - 経費を削除
    - アクセス制御（自分の経費のみ）
    - _要件: 5.2, 5.5_

  - [ ]* 8.6 経費APIの統合テストを作成
    - CRUD操作のテスト
    - フィルタリング機能のテスト
    - アクセス制御のテスト
    - エラーハンドリングのテスト
    - _要件: 10.3_

  - [ ]* 8.7 プロパティテスト: ユーザーデータの分離
    - **プロパティ 1: ユーザーデータの分離**
    - **検証: 要件 5.2, 8.3**
    - _要件: 10.2_

- [ ] 9. サブスクリプション関連APIエンドポイントの実装
  - [ ] 9.1 POST /api/v1/subscriptionsエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプションを作成
    - _要件: 5.3_

  - [ ] 9.2 GET /api/v1/subscriptions/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプションを取得
    - アクセス制御（自分のサブスクリプションのみ）
    - _要件: 5.3, 5.5_

  - [ ] 9.3 GET /api/v1/subscriptionsエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプション一覧を取得
    - クエリパラメータ（activeOnly）でフィルタリング
    - _要件: 5.3_

  - [ ] 9.4 PUT /api/v1/subscriptions/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプションを更新
    - アクセス制御（自分のサブスクリプションのみ）
    - _要件: 5.3, 5.5_

  - [ ] 9.5 PATCH /api/v1/subscriptions/:id/toggleエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプションのステータスを切り替え
    - アクセス制御（自分のサブスクリプションのみ）
    - _要件: 5.3, 5.5_

  - [ ] 9.6 DELETE /api/v1/subscriptions/:idエンドポイントを実装
    - 認証ミドルウェアを適用
    - サブスクリプションを削除
    - アクセス制御（自分のサブスクリプションのみ）
    - _要件: 5.3, 5.5_

  - [ ] 9.7 GET /api/v1/subscriptions/monthly-totalエンドポイントを実装
    - 認証ミドルウェアを適用
    - 月額合計を取得
    - _要件: 5.3_

  - [ ]* 9.8 サブスクリプションAPIの統合テストを作成
    - CRUD操作のテスト
    - ステータス切り替えのテスト
    - 月額合計計算のテスト
    - アクセス制御のテスト
    - エラーハンドリングのテスト
    - _要件: 10.3_

- [ ] 10. チェックポイント - APIエンドポイントのテスト
  - すべてのAPIエンドポイントの統合テストが通ることを確認
  - 質問があればユーザーに確認

- [ ]* 11. プロパティベーステストの実装
  - [ ]* 11.1 プロパティテスト: データの整合性
    - **プロパティ 2: データの整合性**
    - **検証: 要件 2.1, 2.2, 3.1, 3.2, 4.1, 4.2**
    - _要件: 10.2_

  - [ ]* 11.2 プロパティテスト: データの更新
    - **プロパティ 3: データの更新**
    - **検証: 要件 2.4, 3.4, 4.5**
    - _要件: 10.2_

  - [ ]* 11.3 プロパティテスト: データの削除
    - **プロパティ 4: データの削除**
    - **検証: 要件 2.5, 3.6, 4.6, 6.2**
    - _要件: 10.2_

  - [ ]* 11.4 プロパティテスト: 認証の必須性
    - **プロパティ 5: 認証の必須性**
    - **検証: 要件 5.4, 8.1**
    - _要件: 10.2_

  - [ ]* 11.5 プロパティテスト: アクセス制御
    - **プロパティ 6: アクセス制御**
    - **検証: 要件 5.5, 8.3**
    - _要件: 10.2_

- [ ]* 12. データマイグレーションツールの作成
  - [ ]* 12.1 ローカルSQLiteからデータを読み取るスクリプトを作成
    - ユーザーデータ、経費データ、サブスクリプションデータを読み取る
    - _要件: 7.1_

  - [ ]* 12.2 D1にデータをアップロードするスクリプトを作成
    - データの整合性を保ちながらD1に書き込む
    - エラーハンドリングとロールバック機能
    - _要件: 7.2, 7.3_

  - [ ]* 12.3 マイグレーション結果のレポート生成機能を追加
    - マイグレーション結果のサマリーを出力
    - _要件: 7.4_

- [ ] 13. 最終チェックポイント
  - すべてのテストが通ることを確認
  - APIエンドポイントが正しく動作することを確認
  - 質問があればユーザーに確認

## 注意事項

- タスクに`*`が付いているものはオプションタスクです（テスト関連）
- 各タスクは前のタスクが完了してから実行してください
- チェックポイントでは必ずテストを実行し、問題があれば修正してください
- 実装は必要最低限の機能に絞り、シンプルに保ってください
