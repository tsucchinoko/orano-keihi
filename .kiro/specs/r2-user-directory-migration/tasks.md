# 実装計画: R2ユーザーディレクトリ移行

## 概要

既存のCloudflare R2レシート保存システムを`/receipts/`構造から`/users/{user_id}/receipts/`構造に移行する機能の実装。安全で効率的な移行プロセスと、移行後のユーザー別アクセス制御を提供する。

## タスク

- [x] 1. ユーザーパス管理システムの実装
  - ユーザー別ファイルパス生成機能を実装
  - レガシーパスから新パスへの変換機能を実装
  - パスからユーザーID抽出機能を実装
  - ユーザーアクセス権限検証機能を実装
  - _要件: 2.1, 2.2, 8.1, 8.2_

- [ ]* 1.1 新構造パス生成のプロパティテスト作成
  - **プロパティ5: 新構造パス生成**
  - **検証: 要件 2.1**

- [ ]* 1.2 ファイル名一意性のプロパティテスト作成
  - **プロパティ6: ファイル名一意性**
  - **検証: 要件 2.2**

- [ ]* 1.3 ユーザーアクセス制御のプロパティテスト作成
  - **プロパティ7: ユーザーアクセス制御**
  - **検証: 要件 2.5, 8.2**

- [ ] 2. データベーススキーマ拡張
  - migration_logテーブルを作成
  - migration_itemsテーブルを作成
  - 必要なインデックスを追加
  - マイグレーション実行機能を実装
  - _要件: 4.1, 4.2, 4.3_

- [ ]* 2.1 移行進捗表示正確性のプロパティテスト作成
  - **プロパティ12: 移行進捗表示正確性**
  - **検証: 要件 4.1, 4.2**

- [ ] 3. R2移行サービス基盤の実装
  - R2MigrationServiceの基本構造を実装
  - 移行対象ファイル特定機能を実装
  - レガシーファイルリストアップ機能を実装
  - ファイル・ユーザーマッピング機能を実装
  - _要件: 1.1, 1.2_

- [ ]* 3.1 レガシーファイル完全検出のプロパティテスト作成
  - **プロパティ1: レガシーファイル完全検出**
  - **検証: 要件 1.1**

- [ ]* 3.2 ファイル・ユーザーマッピング正確性のプロパティテスト作成
  - **プロパティ2: ファイル・ユーザーマッピング正確性**
  - **検証: 要件 1.2**

- [ ] 4. バッチ処理システムの実装
  - BatchProcessorの基本構造を実装
  - 並列処理制御機能を実装
  - 単一ファイル移行処理を実装
  - ファイルハッシュ計算・検証機能を実装
  - 一時停止・再開・停止機能を実装
  - _要件: 1.3, 4.5, 5.1, 5.2, 9.1_

- [ ]* 4.1 移行プロセス順序保証のプロパティテスト作成
  - **プロパティ3: 移行プロセス順序保証**
  - **検証: 要件 1.4, 10.2**

- [ ]* 4.2 ファイルハッシュ計算・記録のプロパティテスト作成
  - **プロパティ16: ファイルハッシュ計算・記録**
  - **検証: 要件 5.1, 5.2**

- [ ]* 4.3 移行制御機能のプロパティテスト作成
  - **プロパティ15: 移行制御機能**
  - **検証: 要件 4.5, 7.5**

- [ ] 5. 移行検証システムの実装
  - MigrationValidatorの基本構造を実装
  - データ整合性検証機能を実装
  - ファイルアクセス可能性検証機能を実装
  - 孤立ファイル・破損ファイル検出機能を実装
  - 不整合レポート生成機能を実装
  - _要件: 5.3, 5.4, 5.5_

- [ ]* 5.1 データベース・R2整合性検証のプロパティテスト作成
  - **プロパティ17: データベース・R2整合性検証**
  - **検証: 要件 5.3**

- [ ]* 5.2 移行後アクセス可能性のプロパティテスト作成
  - **プロパティ18: 移行後アクセス可能性**
  - **検証: 要件 5.4**

- [ ]* 5.3 不整合レポート提供のプロパティテスト作成
  - **プロパティ19: 不整合レポート提供**
  - **検証: 要件 5.5**

- [ ] 6. データベース更新機能の実装
  - receipt_url更新処理を実装
  - トランザクション処理による整合性保証を実装
  - 更新失敗時のロールバック機能を実装
  - 更新後検証機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 6.1 レガシーURL検出完全性のプロパティテスト作成
  - **プロパティ8: レガシーURL検出完全性**
  - **検証: 要件 3.1**

- [ ]* 6.2 URL変換正確性のプロパティテスト作成
  - **プロパティ9: URL変換正確性**
  - **検証: 要件 3.2**

- [ ]* 6.3 データベース更新トランザクション整合性のプロパティテスト作成
  - **プロパティ10: データベース更新トランザクション整合性**
  - **検証: 要件 3.3**

- [ ]* 6.4 移行失敗時ロールバックのプロパティテスト作成
  - **プロパティ4: 移行失敗時ロールバック**
  - **検証: 要件 1.5, 3.4**

- [ ] 7. 既存R2サービスの更新
  - ユーザー認証付きファイルアップロード機能を実装
  - ユーザー認証付きファイル取得機能を実装
  - ユーザー認証付きファイル削除機能を実装
  - ファイルダウンロード機能を実装
  - URLからパス抽出機能を実装
  - _要件: 2.3, 2.4, 6.1, 6.2, 6.3_

- [ ]* 7.1 移行後機能継続性のプロパティテスト作成
  - **プロパティ20: 移行後機能継続性**
  - **検証: 要件 6.1, 6.2, 6.3**

- [ ]* 7.2 新機能正常動作のプロパティテスト作成
  - **プロパティ21: 新機能正常動作**
  - **検証: 要件 6.4**

- [ ] 8. Tauriコマンドの実装
  - start_r2_migrationコマンドを実装
  - get_migration_statusコマンドを実装
  - pause_migration、resume_migration、stop_migrationコマンドを実装
  - validate_migration_integrityコマンドを実装
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 8.1 移行完了レポート完全性のプロパティテスト作成
  - **プロパティ13: 移行完了レポート完全性**
  - **検証: 要件 4.3**

- [ ]* 8.2 エラー情報記録完全性のプロパティテスト作成
  - **プロパティ14: エラー情報記録完全性**
  - **検証: 要件 4.4**

- [ ] 9. セキュリティとアクセス制御の実装
  - ユーザー認証検証機能を実装
  - Presigned URL生成時のパス制限を実装
  - 管理者権限チェック機能を実装
  - アクセス制御違反検出・ログ記録機能を実装
  - セキュリティ監査ログ機能を実装
  - _要件: 8.1, 8.3, 8.4, 8.5_

- [ ]* 9.1 認証・権限検証のプロパティテスト作成
  - **プロパティ25: 認証・権限検証**
  - **検証: 要件 8.1, 8.3, 8.4, 8.5**

- [ ] 10. パフォーマンス最適化機能の実装
  - 並列処理制御（セマフォ）を実装
  - メモリ使用量制限機能を実装
  - ネットワーク帯域幅制御を実装
  - 大容量ファイル用タイムアウト設定を実装
  - 動的並列度調整機能を実装
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ]* 10.1 パフォーマンス最適化のプロパティテスト作成
  - **プロパティ26: パフォーマンス最適化**
  - **検証: 要件 9.1, 9.2, 9.3, 9.4, 9.5**

- [ ] 11. バックアップとドライラン機能の実装
  - データベースバックアップ作成機能を実装
  - R2重要ファイルリスト記録機能を実装
  - ドライランモード実装
  - バッチサイズ指定機能を実装
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ]* 11.1 バックアップ作成完全性のプロパティテスト作成
  - **プロパティ22: バックアップ作成完全性**
  - **検証: 要件 7.1, 7.2**

- [ ]* 11.2 ドライラン機能のプロパティテスト作成
  - **プロパティ23: ドライラン機能**
  - **検証: 要件 7.3**

- [ ]* 11.3 バッチ処理制御のプロパティテスト作成
  - **プロパティ24: バッチ処理制御**
  - **検証: 要件 7.4**

- [ ] 12. クリーンアップ機能の実装
  - レガシーファイル自動削除機能を実装
  - 削除対象ファイルリスト表示機能を実装
  - 削除エラー処理・ログ記録機能を実装
  - ストレージ使用量削減レポート機能を実装
  - _要件: 10.1, 10.3, 10.4, 10.5_

- [ ]* 12.1 自動クリーンアップのプロパティテスト作成
  - **プロパティ27: 自動クリーンアップ**
  - **検証: 要件 10.1, 10.3**

- [ ]* 12.2 クリーンアップエラー処理のプロパティテスト作成
  - **プロパティ28: クリーンアップエラー処理**
  - **検証: 要件 10.4, 10.5**

- [ ] 13. フロントエンド移行UIの実装
  - MigrationStatusコンポーネントを実装
  - ProgressMonitorコンポーネントを実装
  - MigrationControlコンポーネントを実装
  - エラー表示とユーザーフィードバック機能を実装
  - _要件: 4.1, 4.2, 4.3, 4.5_

- [ ] 14. エラーハンドリングとログ機能の統合
  - MigrationError型を実装
  - 包括的なエラーハンドリングを実装
  - 構造化ログ出力を実装
  - セキュリティ監査ログを統合
  - _要件: 1.5, 4.4, 8.5_

- [ ] 15. 統合テストとデバッグ機能
  - R2移行統合テストを実装
  - 大量ファイル移行テストを実装
  - ネットワーク障害シミュレーションテストを実装
  - パフォーマンステストを実装
  - _要件: 9.1, 9.2, 9.3_

- [ ] 16. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があれば用户に尋ねる

- [ ] 17. ドキュメント更新
  - 移行手順ドキュメントを作成
  - トラブルシューティングガイドを作成
  - セキュリティ設定ガイドを作成
  - パフォーマンス最適化ガイドを作成
  - _要件: 7.1, 7.2, 7.3, 7.4_

## 注意事項

- `*`マークの付いたタスクはオプションで、より迅速なMVPのためにスキップ可能
- 各タスクは特定の要件を参照し、トレーサビリティを確保
- チェックポイントで段階的な検証を実施
- プロパティテストは汎用的な正確性プロパティを検証
- 単体テストは具体的な例とエッジケースを検証