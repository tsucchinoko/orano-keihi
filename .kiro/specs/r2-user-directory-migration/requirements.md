# 要件定義書

## はじめに

既存のCloudflare R2レシート保存システムを、ユーザー別ディレクトリ構造に移行する機能。現在の`/receipts/`配下の構造から`/users/ユーザーID/receipts/`構造に変更し、既存データのマイグレーションとアプリケーションコードの更新を行う。

## 用語集

- **User Directory Structure**: ユーザーID別にファイルを整理するディレクトリ構造（`/users/{user_id}/receipts/`）
- **Legacy Structure**: 既存の`/receipts/`配下の構造
- **R2 Migration**: R2バケット内のオブジェクトを新しい構造に移行する処理
- **Database Migration**: データベース内のreceipt_urlを新しい構造に更新する処理
- **User ID**: 認証されたユーザーの一意識別子
- **Receipt Path**: R2内のレシートファイルのパス
- **Batch Migration**: 複数のファイルを一括で移行する処理

## 要件

### 要件 1

**ユーザーストーリー:** システム管理者として、R2内のレシートファイルをユーザー別ディレクトリ構造に移行したいので、ユーザーデータの分離とセキュリティを向上させられる

#### 受入基準

1. システムがR2バケット内の既存レシートファイル（`/receipts/`配下）を検出する際、すべてのファイルをリストアップする
2. システムが各レシートファイルに対応するユーザーIDをデータベースから特定する際、正確なマッピングを行う
3. システムがファイルを新しい構造（`/users/{user_id}/receipts/`）にコピーする際、ファイル内容とメタデータを保持する
4. システムがコピー完了後に元のファイルを削除する際、データ整合性を確保する
5. システムが移行失敗時に適切なエラーハンドリングとロールバック機能を提供する

### 要件 2

**ユーザーストーリー:** 開発者として、アプリケーションコードを新しいディレクトリ構造に対応させたいので、今後のレシート保存が正しい場所に行われる

#### 受入基準

1. システムが新しいレシートをアップロードする際、`/users/{user_id}/receipts/`構造を使用する
2. システムがレシートファイル名を生成する際、ユーザーID、タイムスタンプ、UUIDを含む一意な名前を作成する
3. システムがレシートをダウンロードする際、新しいディレクトリ構造からファイルを取得する
4. システムがレシートを削除する際、新しいディレクトリ構造内のファイルを対象とする
5. システムが認証されたユーザーのレシートのみアクセス可能にする

### 要件 3

**ユーザーストーリー:** システム管理者として、データベース内のreceipt_urlを新しい構造に更新したいので、アプリケーションが正しいファイルパスを参照できる

#### 受入基準

1. システムがデータベース内のすべてのreceipt_urlを特定する際、既存の`/receipts/`パスを含むレコードを検出する
2. システムがreceipt_urlを新しい構造に変換する際、対応するユーザーIDを使用してパスを更新する
3. システムがURL更新を実行する際、トランザクション処理で整合性を保証する
4. システムが更新失敗時にロールバック機能を提供する
5. システムが更新完了後に変更内容を検証する

### 要件 4

**ユーザーストーリー:** システム管理者として、移行プロセスの進捗を監視したいので、移行状況を把握し、問題発生時に対応できる

#### 受入基準

1. システムが移行開始前に移行対象ファイル数を表示する
2. システムが移行中にリアルタイムで進捗状況（処理済み/総数）を表示する
3. システムが移行完了時に成功・失敗の詳細レポートを提供する
4. システムが移行エラー発生時に詳細なエラー情報とスタックトレースを記録する
5. システムが移行プロセスを一時停止・再開する機能を提供する

### 要件 5

**ユーザーストーリー:** システム管理者として、移行前後のデータ整合性を検証したいので、データ損失や破損がないことを確認できる

#### 受入基準

1. システムが移行前にすべてのレシートファイルのハッシュ値を計算して記録する
2. システムが移行後に新しい場所のファイルのハッシュ値を計算して比較する
3. システムがデータベース内のreceipt_url数と実際のR2ファイル数の整合性を検証する
4. システムが移行完了後に全レシートファイルのアクセス可能性をテストする
5. システムが整合性チェック失敗時に詳細な不整合レポートを提供する

### 要件 6

**ユーザーストーリー:** ユーザーとして、移行後も既存のレシートに正常にアクセスできることを期待するので、業務の継続性を保てる

#### 受入基準

1. システムが移行完了後に既存のレシート表示機能が正常に動作する
2. システムが移行完了後にレシートのダウンロード機能が正常に動作する
3. システムが移行完了後にレシートの削除機能が正常に動作する
4. システムが移行完了後に新しいレシートのアップロード機能が新しい構造で動作する
5. システムが移行完了後にユーザーが自分のレシートのみアクセス可能であることを保証する

### 要件 7

**ユーザーストーリー:** システム管理者として、移行処理を安全に実行したいので、本番環境でのリスクを最小化できる

#### 受入基準

1. システムが移行実行前にデータベースの完全バックアップを作成する
2. システムが移行実行前にR2バケットの重要ファイルリストを記録する
3. システムが移行処理をドライランモードで事前テストできる機能を提供する
4. システムが移行処理を段階的に実行する機能（バッチサイズ指定）を提供する
5. システムが緊急時に移行処理を即座に停止する機能を提供する

### 要件 8

**ユーザーストーリー:** 開発者として、移行後のセキュリティを強化したいので、ユーザー間のデータアクセス制御を適切に実装できる

#### 受入基準

1. システムがレシートアクセス時に認証されたユーザーIDを検証する
2. システムが他のユーザーのレシートへのアクセスを拒否する
3. システムがPresigned URL生成時にユーザーIDベースのパス制限を適用する
4. システムが管理者権限でのみ全ユーザーのレシートにアクセス可能にする
5. システムがアクセス制御違反を検出してログに記録する

### 要件 9

**ユーザーストーリー:** システム管理者として、移行処理のパフォーマンスを最適化したいので、大量のファイル移行を効率的に実行できる

#### 受入基準

1. システムが複数のファイルを並列処理で移行する機能を提供する
2. システムが移行処理中のメモリ使用量を制限する機能を提供する
3. システムがネットワーク帯域幅を考慮した転送速度制御を提供する
4. システムが移行処理中にアプリケーションの通常動作を阻害しない
5. システムが大容量ファイルの移行時に適切なタイムアウト設定を適用する

### 要件 10

**ユーザーストーリー:** システム管理者として、移行完了後のクリーンアップを自動化したいので、不要なファイルやデータを効率的に削除できる

#### 受入基準

1. システムが移行完了後に古い`/receipts/`構造のファイルを自動削除する
2. システムが削除前に移行成功を再確認する
3. システムが削除対象ファイルのリストを事前に表示して確認を求める
4. システムが削除処理中にエラーが発生した場合に詳細ログを記録する
5. システムがクリーンアップ完了後にストレージ使用量の削減を報告する