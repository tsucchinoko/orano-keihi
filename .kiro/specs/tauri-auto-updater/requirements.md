# 要件定義書

## 概要

Tauri v2のupdaterプラグインを使用して、GitHub Releasesの静的JSONファイルベースの自動アップデート機能を実装する。アプリケーション起動時にアップデートをチェックし、新しいバージョンが利用可能な場合はユーザーに通知してインストールを促す。

## 用語集

- **Updater**: Tauri v2のアップデート機能を提供するプラグイン
- **Static_JSON**: GitHub Releasesに配置される静的なJSONファイル形式のアップデート情報
- **Update_Check**: アプリケーションが新しいバージョンの存在を確認する処理
- **Update_Dialog**: ユーザーにアップデートの可否を確認するダイアログ
- **Auto_Install**: ユーザーの承認後に自動的にアップデートをダウンロード・インストールする機能
- **Release_Workflow**: GitHub Actionsでリリース時に静的JSONファイルを生成・配置するワークフロー

## 要件

### 要件 1: アップデートチェック機能

**ユーザーストーリー:** アプリケーション利用者として、アプリ起動時に自動的に最新バージョンがチェックされることで、常に最新の機能とセキュリティ修正を利用したい。

#### 受け入れ基準

1. アプリケーション起動時に、システムは自動的にアップデートチェックを実行する
2. アップデートチェック中にエラーが発生した場合、システムはサイレントに処理を継続し、ユーザー体験を阻害しない
3. ネットワーク接続がない場合、システムはアップデートチェックをスキップし、通常の起動を継続する
4. アップデートチェックは非同期で実行され、アプリケーションの起動時間に影響を与えない

### 要件 2: アップデート通知機能

**ユーザーストーリー:** アプリケーション利用者として、新しいバージョンが利用可能な場合に分かりやすい通知を受け取り、アップデートするかどうかを選択したい。

#### 受け入れ基準

1. 新しいバージョンが利用可能な場合、システムはユーザーにダイアログで通知する
2. ダイアログには現在のバージョン、新しいバージョン、リリースノートが表示される
3. ユーザーが「今すぐアップデート」を選択した場合、システムは自動インストールを開始する
4. ユーザーが「後で」を選択した場合、システムは通常の動作を継続し、次回起動時に再度チェックする
5. ユーザーが「スキップ」を選択した場合、システムは該当バージョンのアップデート通知を無効化する

### 要件 3: 自動インストール機能

**ユーザーストーリー:** アプリケーション利用者として、アップデートの承認後は自動的にダウンロード・インストールが実行され、手動での操作なしに最新バージョンを利用したい。

#### 受け入れ基準

1. ユーザーがアップデートを承認した場合、システムは自動的にアップデートファイルをダウンロードする
2. ダウンロード中はプログレスバーでダウンロード状況を表示する
3. ダウンロード完了後、システムは自動的にインストールを実行し、アプリケーションを再起動する
4. インストール中にエラーが発生した場合、システムはエラーメッセージを表示し、ロールバック処理を実行する
5. インストール完了後、システムは新しいバージョンでアプリケーションを再起動する

### 要件 4: 静的JSONファイル生成機能

**ユーザーストーリー:** 開発者として、GitHub Actionsのリリースワークフロー実行時に、各プラットフォーム用の静的JSONファイルが自動生成され、GitHub Releasesに配置されることで、手動でのアップデート情報管理を不要にしたい。

#### 受け入れ基準

1. リリースワークフロー実行時に、システムは各プラットフォーム（macOS、Windows）用の静的JSONファイルを生成する
2. 静的JSONファイルには、バージョン情報、ダウンロードURL、署名情報、リリースノートが含まれる
3. 生成された静的JSONファイルは、GitHub Releasesの成果物として自動的にアップロードされる
4. 各プラットフォームのアーキテクチャ（x64、arm64）に対応した個別のJSONファイルが生成される
5. JSONファイルのフォーマットは、Tauri updaterプラグインの仕様に準拠する

### 要件 5: セキュリティ機能

**ユーザーストーリー:** アプリケーション利用者として、アップデートファイルの整合性と真正性が検証されることで、安全にアップデートを適用したい。

#### 受け入れ基準

1. すべてのアップデートファイルは、デジタル署名による検証を実行する
2. 署名検証に失敗した場合、システムはアップデートを中止し、エラーメッセージを表示する
3. HTTPS通信のみを使用してアップデート情報とファイルをダウンロードする
4. ダウンロードしたファイルのハッシュ値を検証し、改ざんを検出する
5. 公開鍵は、アプリケーションにハードコードされ、外部からの変更を防ぐ

### 要件 6: エラーハンドリング機能

**ユーザーストーリー:** アプリケーション利用者として、アップデート処理中にエラーが発生した場合でも、適切なエラーメッセージが表示され、アプリケーションが正常に動作し続けることを期待する。

#### 受け入れ基準

1. ネットワークエラーが発生した場合、システムは分かりやすいエラーメッセージを表示し、再試行オプションを提供する
2. ダウンロードエラーが発生した場合、システムは部分ダウンロードをクリーンアップし、再ダウンロードを実行する
3. インストールエラーが発生した場合、システムは元のバージョンを保持し、ロールバック処理を実行する
4. 署名検証エラーが発生した場合、システムはセキュリティ警告を表示し、アップデートを中止する
5. すべてのエラー情報は、ログファイルに記録され、トラブルシューティングに活用できる

### 要件 7: 設定管理機能

**ユーザーストーリー:** アプリケーション利用者として、アップデート機能の動作を自分の好みに合わせて設定できることで、より快適にアプリケーションを利用したい。

#### 受け入れ基準

1. ユーザーは、自動アップデートチェックの有効/無効を設定できる
2. ユーザーは、アップデートチェックの頻度（起動時のみ、定期的）を選択できる
3. ユーザーは、ベータ版アップデートの受信可否を設定できる
4. ユーザーは、特定のバージョンのアップデート通知をスキップできる
5. すべての設定は、アプリケーションの再起動後も保持される