# 実装計画

- [x] 1. 共有モジュールの基盤を準備する
  - shared/ディレクトリ構造を作成し、共通機能の基盤を構築する
  - 統一されたエラーハンドリングシステムを実装する
  - 共通のデータベース接続管理を実装する
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.1 shared/errorsモジュールを作成する
  - AppError列挙型と統一されたエラーハンドリングを実装する
  - エラーの重要度分類とユーザーフレンドリーメッセージ機能を追加する
  - _要件: 4.3_

- [x] 1.2 shared/databaseモジュールを作成する
  - 既存のdb/connection.rsをshared/database/connection.rsに移動・リファクタリングする
  - データベース初期化とテーブル作成機能を統合する
  - _要件: 4.1_

- [x] 1.3 shared/configモジュールを作成する
  - 既存のconfig/environment.rsとinitialization.rsをshared/configに移動する
  - 環境設定管理を統一する
  - _要件: 4.2_

- [x] 1.4 shared/utilsモジュールを作成する
  - 共通のバリデーション機能（日付、金額など）を実装する
  - 複数の機能で使用される汎用ユーティリティを集約する
  - _要件: 4.5_

- [ ]* 1.5 共有モジュールのプロパティテストを作成する
  - **プロパティ4: 共有モジュールの一貫した使用**
  - **検証対象: 要件 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 2. Expenses機能モジュールを作成する
  - features/expenses/ディレクトリ構造を作成する
  - 既存の経費関連コードを機能モジュールに移行する
  - 共有モジュールとの統合を行う
  - _要件: 1.1, 2.1, 2.2, 3.1, 3.2_

- [x] 2.1 features/expenses/models.rsを作成する
  - 既存のmodels/expense.rsの内容を移行する
  - DTOとデータモデルを整理する
  - _要件: 1.1_

- [x] 2.2 features/expenses/repository.rsを作成する
  - 既存のdb/expense_operations.rsの内容を移行する
  - 共有データベース接続を使用するよう修正する
  - _要件: 1.1, 2.2_

- [x] 2.3 features/expenses/commands.rsを作成する
  - 既存のcommands/expense_commands.rsの内容を移行する
  - 統一されたエラーハンドリングを使用するよう修正する
  - _要件: 1.1, 2.1, 3.1_

- [x] 2.4 features/expenses/mod.rsを作成する
  - 経費機能の公開インターフェースを定義する
  - モジュール境界を明確にする
  - _要件: 2.1, 2.3_

- [ ]* 2.5 経費機能のプロパティテストを作成する
  - **プロパティ3: 後方互換性の保持**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ]* 2.6 経費機能のユニットテストを作成する
  - バリデーション機能のテスト
  - データベース操作のテスト
  - エラーハンドリングのテスト
  - _要件: 1.1, 3.1, 3.2_

- [x] 3. Subscriptions機能モジュールを作成する
  - features/subscriptions/ディレクトリ構造を作成する
  - 既存のサブスクリプション関連コードを機能モジュールに移行する
  - 共有モジュールとの統合を行う
  - _要件: 1.2, 2.1, 2.2, 3.1, 3.2_

- [x] 3.1 features/subscriptions/models.rsを作成する
  - 既存のmodels/subscription.rsの内容を移行する
  - DTOとデータモデルを整理する
  - _要件: 1.2_

- [x] 3.2 features/subscriptions/repository.rsを作成する
  - 既存のdb/subscription_operations.rsの内容を移行する
  - 共有データベース接続を使用するよう修正する
  - _要件: 1.2, 2.2_

- [x] 3.3 features/subscriptions/commands.rsを作成する
  - 既存のcommands/subscription_commands.rsの内容を移行する
  - 統一されたエラーハンドリングを使用するよう修正する
  - _要件: 1.2, 2.1, 3.1_

- [x] 3.4 features/subscriptions/mod.rsを作成する
  - サブスクリプション機能の公開インターフェースを定義する
  - モジュール境界を明確にする
  - _要件: 2.1, 2.3_

- [ ]* 3.5 サブスクリプション機能のプロパティテストを作成する
  - **プロパティ3: 後方互換性の保持**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ]* 3.6 サブスクリプション機能のユニットテストを作成する
  - バリデーション機能のテスト
  - データベース操作のテスト
  - 月額合計計算のテスト
  - _要件: 1.2, 3.1, 3.2_

- [ ] 4. チェックポイント - 基本機能の動作確認
  - すべてのテストが成功することを確認し、ユーザーに質問があれば尋ねる

- [x] 5. Receipts機能モジュールを作成する
  - features/receipts/ディレクトリ構造を作成する
  - 既存の領収書関連コードを機能モジュールに移行する
  - R2クライアントとキャッシュマネージャーを統合する
  - _要件: 1.3, 2.1, 2.2, 3.1, 3.2_

- [x] 5.1 features/receipts/models.rsを作成する
  - 領収書関連のデータモデルとDTOを定義する
  - ReceiptCacheモデルを移行する
  - _要件: 1.3_

- [x] 5.2 features/receipts/service.rsを作成する
  - 既存のservices/r2_client.rsの内容を移行する
  - R2との連携機能を実装する
  - _要件: 1.3, 2.2_

- [x] 5.3 features/receipts/cache.rsを作成する
  - 既存のservices/cache_manager.rsの内容を移行する
  - オフライン対応とキャッシュ管理を実装する
  - _要件: 1.3, 2.2_

- [x] 5.4 features/receipts/commands.rsを作成する
  - 既存のcommands/receipt_commands.rsの内容を移行する
  - 統一されたエラーハンドリングを使用するよう修正する
  - _要件: 1.3, 2.1, 3.1_

- [x] 5.5 features/receipts/mod.rsを作成する
  - 領収書機能の公開インターフェースを定義する
  - モジュール境界を明確にする
  - _要件: 2.1, 2.3_

- [ ]* 5.6 領収書機能のプロパティテストを作成する
  - **プロパティ3: 後方互換性の保持**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ]* 5.7 領収書機能のユニットテストを作成する
  - R2アップロード/ダウンロード機能のテスト
  - キャッシュ機能のテスト
  - 並列処理のテスト
  - _要件: 1.3, 3.1, 3.2_

- [x] 6. Security機能モジュールを作成する
  - features/security/ディレクトリ構造を作成する
  - 既存のセキュリティ関連コードを機能モジュールに移行する
  - _要件: 1.4, 2.1, 2.2, 3.1, 3.4_

- [x] 6.1 features/security/models.rsを作成する
  - セキュリティ関連のデータモデルを定義する
  - 診断情報とテスト結果の構造体を移行する
  - _要件: 1.4_

- [x] 6.2 features/security/service.rsを作成する
  - 既存のservices/security.rsの内容を移行する
  - SecurityManagerとEnvironmentConfigを実装する
  - _要件: 1.4, 2.2_

- [x] 6.3 features/security/commands.rsを作成する
  - 既存のcommands/security_commands.rsの内容を移行する
  - セキュリティ関連のTauriコマンドを実装する
  - _要件: 1.4, 2.1, 3.1_

- [x] 6.4 features/security/mod.rsを作成する
  - セキュリティ機能の公開インターフェースを定義する
  - モジュール境界を明確にする
  - _要件: 2.1, 2.3_

- [ ]* 6.5 セキュリティ機能のプロパティテストを作成する
  - **プロパティ3: 後方互換性の保持**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ]* 6.6 セキュリティ機能のユニットテストを作成する
  - 設定検証機能のテスト
  - セキュリティイベントログのテスト
  - 診断情報取得のテスト
  - _要件: 1.4, 3.1, 3.4_

- [x] 7. Migrations機能モジュールを作成する
  - features/migrations/ディレクトリ構造を作成する
  - 既存のマイグレーション関連コードを機能モジュールに移行する
  - _要件: 1.5, 2.1, 2.2, 3.1, 3.2_

- [x] 7.1 features/migrations/service.rsを作成する
  - 既存のdb/migrations.rsの内容を移行する
  - マイグレーション実行とバックアップ機能を実装する
  - _要件: 1.5, 2.2_

- [x] 7.2 features/migrations/commands.rsを作成する
  - 既存のcommands/migration_commands.rsの内容を移行する
  - マイグレーション関連のTauriコマンドを実装する
  - _要件: 1.5, 2.1, 3.1_

- [x] 7.3 features/migrations/mod.rsを作成する
  - マイグレーション機能の公開インターフェースを定義する
  - モジュール境界を明確にする
  - _要件: 2.1, 2.3_

- [ ]* 7.4 マイグレーション機能のプロパティテストを作成する
  - **プロパティ3: 後方互換性の保持**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ]* 7.5 マイグレーション機能のユニットテストを作成する
  - マイグレーション実行のテスト
  - バックアップ作成・復元のテスト
  - マイグレーション状態確認のテスト
  - _要件: 1.5, 3.1, 3.2_

- [ ] 8. lib.rsを更新して新しい構造に対応する
  - 新しい機能モジュール構造を反映する
  - Tauriコマンドハンドラーの登録を更新する
  - AppStateの構造を調整する
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 8.1 lib.rsのモジュール宣言を更新する
  - featuresモジュールとsharedモジュールを宣言する
  - 古いモジュール宣言を削除する
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 8.2 Tauriコマンドハンドラーの登録を更新する
  - 新しい機能モジュールからコマンドをインポートする
  - invoke_handlerマクロを更新する
  - _要件: 3.1_

- [ ] 8.3 AppStateの構造を調整する
  - 共有モジュールを使用するよう修正する
  - 初期化処理を更新する
  - _要件: 2.2, 4.1, 4.2_

- [ ] 9. チェックポイント - 統合テストの実行
  - すべてのテストが成功することを確認し、ユーザーに質問があれば尋ねる

- [ ] 10. 統合テストとプロパティテストを作成する
  - ディレクトリ構造の検証テストを実装する
  - モジュール境界の整合性テストを実装する
  - 段階的リファクタリングの独立性テストを実装する
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 5.1, 5.2, 5.5_

- [ ]* 10.1 ディレクトリ構造検証のプロパティテストを作成する
  - **プロパティ1: 機能別ディレクトリ構造の正当性**
  - **検証対象: 要件 1.1, 1.2, 1.3, 1.4, 1.5**

- [ ]* 10.2 モジュール境界検証のプロパティテストを作成する
  - **プロパティ2: モジュール境界の正当性**
  - **検証対象: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [ ]* 10.3 段階的リファクタリング独立性のプロパティテストを作成する
  - **プロパティ5: 段階的リファクタリングの独立性**
  - **検証対象: 要件 5.1, 5.2, 5.5**

- [ ] 11. 古い技術レイヤーディレクトリを削除する
  - commands/, models/, db/, services/, config/ディレクトリを削除する
  - 不要なファイルをクリーンアップする
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 11.1 古いcommandsディレクトリを削除する
  - 機能モジュールへの移行が完了していることを確認する
  - commands/ディレクトリとその内容を削除する
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 11.2 古いmodelsディレクトリを削除する
  - 機能モジュールへの移行が完了していることを確認する
  - models/ディレクトリとその内容を削除する
  - _要件: 1.1, 1.2_

- [ ] 11.3 古いdbディレクトリを削除する
  - 共有モジュールと機能モジュールへの移行が完了していることを確認する
  - db/ディレクトリとその内容を削除する
  - _要件: 1.1, 1.2, 1.5, 4.1_

- [ ] 11.4 古いservicesディレクトリを削除する
  - 機能モジュールへの移行が完了していることを確認する
  - services/ディレクトリとその内容を削除する
  - _要件: 1.3, 1.4_

- [ ] 11.5 古いconfigディレクトリを削除する
  - 共有モジュールへの移行が完了していることを確認する
  - config/ディレクトリとその内容を削除する
  - _要件: 4.2_

- [ ] 12. 最終チェックポイント - 全体テストの実行
  - すべてのテストが成功することを確認し、ユーザーに質問があれば尋ねる