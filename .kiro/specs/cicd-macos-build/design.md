# 設計書

## 概要

GitHubのmainブランチマージ時にMacOS向けdmgファイルを自動生成するCI/CDパイプラインと、開発・プロダクション環境でのデータベース分離機能を設計する。GitHub Actionsを使用してTauriアプリケーションのビルド、パッケージング、リリース配布を自動化し、環境に応じたデータベースファイル管理を実装する。

## アーキテクチャ

### システム構成

```mermaid
graph TB
    A[開発者] -->|プルリクエストマージ| B[GitHub Repository]
    B -->|Webhook| C[GitHub Actions]
    C -->|ビルド実行| D[MacOS Runner]
    D -->|Tauri Build| E[dmgファイル生成]
    E -->|アップロード| F[GitHub Release]
    F -->|ダウンロード| G[エンドユーザー]
    
    H[アプリケーション] -->|環境判定| I{実行環境}
    I -->|開発| J[dev_expenses.db]
    I -->|プロダクション| K[expenses.db]
```

### CI/CDパイプライン設計

1. **トリガー**: mainブランチへのプッシュ
2. **ビルド環境**: GitHub Actions MacOS runner
3. **ビルドプロセス**: 
   - 依存関係インストール
   - フロントエンドビルド（Deno + SvelteKit）
   - Tauriアプリケーションビルド
   - dmgファイル生成
4. **成果物管理**: GitHub Releases経由での配布

### データベース分離設計

環境変数とビルド設定を使用して、開発環境とプロダクション環境で異なるデータベースファイル名を使用する。

## コンポーネントと インターフェース

### GitHub Actionsワークフロー

**ファイル**: `.github/workflows/release.yml`

主要なステップ:
- Node.js/Deno環境セットアップ
- Rust環境セットアップ
- 依存関係インストール
- フロントエンドビルド
- Tauriアプリケーションビルド
- dmgファイル生成
- GitHubリリース作成
- アセット添付

### 環境設定管理

**ファイル**: `src-tauri/src/config/environment.rs`

環境判定とデータベースパス決定のロジックを実装:
```rust
pub enum Environment {
    Development,
    Production,
}

pub fn get_environment() -> Environment {
    // ビルド時の環境変数またはデバッグビルドかどうかで判定
}

pub fn get_database_filename(env: Environment) -> &'static str {
    match env {
        Environment::Development => "dev_expenses.db",
        Environment::Production => "expenses.db",
    }
}
```

### ビルド設定更新

**ファイル**: `src-tauri/tauri.conf.json`

プロダクションビルド用の設定を追加:
- バンドル設定の最適化
- アプリケーション識別子の確認
- アイコンとメタデータの設定

## データモデル

### 環境設定

```rust
#[derive(Debug, Clone)]
pub struct AppConfig {
    pub environment: Environment,
    pub database_path: PathBuf,
    pub app_data_dir: PathBuf,
}
```

### ビルド情報

```rust
#[derive(Debug)]
pub struct BuildInfo {
    pub version: String,
    pub build_date: String,
    pub commit_hash: String,
    pub environment: Environment,
}
```

## 正確性プロパティ

*プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。これは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。*
### プロパティ反映

プロパティの冗長性を排除するため、以下の統合を行います：

- プロパティ3.1と3.2は環境に応じたデータベースファイル選択という同じ概念をテストしているため、統合可能
- プロパティ1.2と1.4は両方ともビルド成功時の成果物に関するものなので、統合可能
- プロパティ5.1と5.2は両方ともリリース作成プロセスに関するものなので、統合可能

**プロパティ1: ビルド成功時の成果物生成**
*すべての*成功したビルドプロセスに対して、dmgファイルが生成され、ダウンロード可能な状態でGitHub Actionsの成果物として保存される
**検証対象: 要件 1.2, 1.4**

**プロパティ2: 署名済み実行可能ファイルの提供**
*すべての*生成されたdmgファイルに対して、署名済みで実行可能なアプリケーションが含まれている
**検証対象: 要件 2.2**

**プロパティ3: 初回起動時の初期化**
*すべての*初回起動に対して、適切なアプリケーションデータディレクトリが作成され、プロダクション用データベースが初期化される
**検証対象: 要件 2.4**

**プロパティ4: 環境に応じたデータベースファイル選択**
*すべての*アプリケーション起動に対して、実行環境（開発/プロダクション）に応じて適切なデータベースファイル名が選択される
**検証対象: 要件 3.1, 3.2**

**プロパティ5: 環境切り替え時のパス自動選択**
*すべての*環境切り替えに対して、適切なデータベースファイルパスが自動的に選択される
**検証対象: 要件 3.3**

**プロパティ6: データベースファイル自動作成**
*すべての*データベースファイルが存在しない状況に対して、環境に応じた適切な場所に新しいデータベースファイルが作成される
**検証対象: 要件 3.4**

**プロパティ7: 固定依存関係の使用**
*すべての*ビルドプロセスに対して、固定されたバージョンの依存関係が使用される
**検証対象: 要件 4.1**

**プロパティ8: ビルドの再現性**
*すべての*同じ入力に対して、ビルド環境が変更されても同じ出力が生成される
**検証対象: 要件 4.2**

**プロパティ9: ビルド失敗時のログ提供**
*すべての*ビルド失敗に対して、詳細なログ情報が提供され、問題の特定が支援される
**検証対象: 要件 4.3**

**プロパティ10: 新コミット時のビルド状態クリア**
*すべての*新しいコミットプッシュに対して、前回のビルド状態がクリアされて新しいビルドが開始される
**検証対象: 要件 4.4**

**プロパティ11: 自動リリース生成とアセット添付**
*すべての*mainブランチマージ完了に対して、バージョンタグとGitHubリリースが自動作成され、生成されたdmgファイルがリリースアセットとして添付される
**検証対象: 要件 5.1, 5.2**

**プロパティ12: リリースノート自動生成**
*すべての*リリースノート生成要求に対して、最新のコミットメッセージから自動的にリリースノートが生成される
**検証対象: 要件 5.3**

**プロパティ13: リリース完了通知**
*すべての*リリースプロセス完了に対して、関係者に通知が送信される
**検証対象: 要件 5.4**

## エラーハンドリング

### ビルドエラー

- 依存関係インストール失敗
- コンパイルエラー
- パッケージング失敗
- 署名エラー

各エラーに対して適切なログ出力と通知機能を実装する。

### 環境設定エラー

- 無効な環境変数
- データベースファイル作成権限エラー
- アプリケーションデータディレクトリアクセスエラー

フォールバック機能と詳細なエラーメッセージを提供する。

### GitHub Actions エラー

- ランナー環境エラー
- 認証エラー
- リリース作成エラー

リトライ機能と適切なエラー報告を実装する。

## テスト戦略

### 単体テスト

- 環境判定ロジックのテスト
- データベースパス生成のテスト
- 設定ファイル読み込みのテスト

### プロパティベーステスト

プロパティベーステストには**fast-check**（TypeScript/JavaScript）と**proptest**（Rust）を使用する。各プロパティベーステストは最低100回の反復実行を行う。

各プロパティベーステストには、設計書の正確性プロパティを参照するコメントを以下の形式で付与する：
`**Feature: cicd-macos-build, Property {番号}: {プロパティテキスト}**`

### 統合テスト

- GitHub Actionsワークフローのテスト
- エンドツーエンドビルドプロセスのテスト
- リリース作成プロセスのテスト

### 手動テスト

- dmgファイルのインストールテスト
- MacOS環境での動作確認
- 署名検証テスト