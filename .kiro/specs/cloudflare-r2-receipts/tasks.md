# 実装計画

- [x] 1. R2サービス基盤の構築
  - Cargo.tomlに必要な依存関係を追加（aws-sdk-s3、tokio、uuid等）
  - R2クライアント設定とテスト接続機能を実装
  - 環境変数からの設定読み込み機能を実装
  - _要件: 3.1, 7.1_

- [ ]* 1.1 R2接続テストのプロパティテスト作成
  - **プロパティ16: R2接続テスト**
  - **検証: 要件 7.1**

- [x] 2. データベースマイグレーション実装
  - receipt_pathからreceipt_urlへのマイグレーションスクリプト作成
  - HTTPS URL制約の追加
  - マイグレーション実行とロールバック機能の実装
  - _要件: 5.1, 5.2, 5.4_

- [ ]* 2.1 URL形式制約のプロパティテスト作成
  - **プロパティ11: URL形式制約**
  - **検証: 要件 5.2**

- [ ]* 2.2 マイグレーションロールバックのプロパティテスト作成
  - **プロパティ12: マイグレーション失敗時のロールバック**
  - **検証: 要件 5.4**

- [x] 3. R2アップロード機能実装
  - ファイルアップロード機能をR2対応に変更
  - ファイル形式とサイズの事前検証
  - プログレス表示とキャンセル機能
  - リトライ機能付きアップロード
  - _要件: 1.1, 1.5, 4.2, 4.3_

- [ ]* 3.1 アップロード完全性のプロパティテスト作成
  - **プロパティ1: 領収書アップロードの完全性**
  - **検証: 要件 1.1, 1.2**

- [ ]* 3.2 ファイル形式検証のプロパティテスト作成
  - **プロパティ2: ファイル形式検証**
  - **検証: 要件 1.5**

- [ ]* 3.3 ファイルサイズ検証のプロパティテスト作成
  - **プロパティ9: ファイルサイズ事前検証**
  - **検証: 要件 4.3**

- [ ]* 3.4 ネットワークリトライのプロパティテスト作成
  - **プロパティ8: ネットワークエラーリトライ**
  - **検証: 要件 4.2**

- [x] 4. R2ダウンロード機能実装
  - Presigned URLを使用した安全なダウンロード機能
  - 領収書表示機能のR2対応
  - エラーハンドリングとフォールバック
  - _要件: 2.1, 2.2, 2.4_

- [ ]* 4.1 領収書取得一貫性のプロパティテスト作成
  - **プロパティ4: 領収書取得の一貫性**
  - **検証: 要件 2.1, 2.2**

- [ ]* 4.2 ファイル表示対応のプロパティテスト作成
  - **プロパティ5: ファイル表示の対応形式**
  - **検証: 要件 2.5**

- [x] 5. ローカルキャッシュシステム実装
  - キャッシュマネージャーの実装
  - LRUキャッシュとサイズ管理
  - オフライン時のキャッシュ表示機能
  - キャッシュ同期機能
  - _要件: 8.1, 8.2, 8.3, 8.5_

- [ ]* 5.1 キャッシュ保存のプロパティテスト作成
  - **プロパティ18: 領収書キャッシュ保存**
  - **検証: 要件 8.1**

- [ ]* 5.2 オフラインキャッシュのプロパティテスト作成
  - **プロパティ19: オフライン時キャッシュ表示**
  - **検証: 要件 8.2**

- [ ]* 5.3 キャッシュライフサイクルのプロパティテスト作成
  - **プロパティ20: キャッシュライフサイクル管理**
  - **検証: 要件 8.3, 8.5**

- [ ] 6. 削除機能のR2対応
  - 経費削除時のR2ファイル削除機能
  - トランザクション的な削除処理（R2→DB順）
  - 削除失敗時のロールバック
  - 削除操作のログ記録
  - _要件: 6.1, 6.2, 6.3, 6.5_

- [ ]* 6.1 経費削除時領収書削除のプロパティテスト作成
  - **プロパティ13: 経費削除時の領収書削除**
  - **検証: 要件 6.1, 6.2**

- [ ]* 6.2 削除失敗時状態保持のプロパティテスト作成
  - **プロパティ14: R2削除失敗時の状態保持**
  - **検証: 要件 6.3**

- [ ]* 6.3 削除ログ記録のプロパティテスト作成
  - **プロパティ15: 削除操作のログ記録**
  - **検証: 要件 6.5**

- [ ] 7. セキュリティとログ機能実装
  - 認証情報の安全な管理
  - ログ出力時の認証情報保護
  - 環境別設定対応
  - デバッグ情報の提供
  - _要件: 3.1, 3.5, 7.3, 7.4_

- [ ]* 7.1 認証情報読み込みのプロパティテスト作成
  - **プロパティ6: 認証情報の環境変数読み込み**
  - **検証: 要件 3.1**

- [ ]* 7.2 ログ保護のプロパティテスト作成
  - **プロパティ7: 認証情報のログ保護**
  - **検証: 要件 3.5**

- [ ]* 7.3 環境別設定のプロパティテスト作成
  - **プロパティ17: 環境別設定**
  - **検証: 要件 7.3**

- [ ] 8. フロントエンド更新
  - ExpenseFormコンポーネントのR2アップロード対応
  - ReceiptViewerコンポーネントのR2表示対応
  - アップロードプログレス表示の実装
  - エラーハンドリングとユーザーフィードバック
  - _要件: 1.3, 2.3, 4.4_

- [ ] 9. 並列処理とパフォーマンス最適化
  - 複数ファイル同時アップロード機能
  - アップロードキャンセル機能
  - パフォーマンス監視機能
  - _要件: 4.4, 4.5_

- [ ]* 9.1 並列アップロードのプロパティテスト作成
  - **プロパティ10: 並列アップロード対応**
  - **検証: 要件 4.5**

- [ ] 10. エラーハンドリング統合
  - 統一されたエラーハンドリング
  - アップロード失敗時の状態保持
  - ユーザーフレンドリーなエラーメッセージ
  - _要件: 1.4, 2.4, 6.3_

- [ ]* 10.1 アップロード失敗状態保持のプロパティテスト作成
  - **プロパティ3: アップロード失敗時の状態保持**
  - **検証: 要件 1.4**

- [ ] 11. 統合テストとデバッグ機能
  - R2接続テスト機能の実装
  - 使用量監視機能
  - 開発者向けデバッグツール
  - _要件: 7.1, 7.4, 7.5_

- [ ] 12. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があれば用户に尋ねる

- [ ] 13. ドキュメント更新
  - R2設定手順の文書化
  - 環境変数設定ガイド
  - トラブルシューティングガイド
  - _要件: 7.2_