# 要件定義書

## はじめに

既存の経費管理アプリケーションの領収書保存機能を、ローカルファイルシステムからCloudflare R2クラウドストレージに移行する機能拡張。これにより、領収書の安全なクラウド保存、デバイス間でのアクセス、バックアップの自動化を実現する。

## 用語集

- **Cloudflare R2**: Cloudflareが提供するS3互換のオブジェクトストレージサービス
- **Receipt URL**: R2に保存された領収書ファイルへのHTTPS URL
- **Receipt Path**: 従来のローカルファイルパス（廃止予定）
- **Presigned URL**: 一時的なアクセス権限付きURL（アップロード/ダウンロード用）
- **R2 Bucket**: R2内のファイル保存コンテナ
- **Expense Tracker**: 既存の経費管理アプリケーション
- **Migration**: 既存データの新システムへの移行（今回は対象外）

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、領収書をクラウドに安全に保存したいので、デバイスの故障やデータ損失から領収書を保護できる

#### 受入基準

1. ユーザーが領収書ファイルをアップロードする際、システムはファイルをCloudflare R2に保存する
2. システムがR2へのアップロードに成功した場合、データベースにreceipt_urlとしてHTTPS URLを保存する
3. システムはアップロード中にプログレス表示を提供する
4. アップロードが失敗した場合、システムはエラーメッセージを表示し、データベースには保存しない
5. システムは対応ファイル形式（PNG、JPG、JPEG、PDF）のみアップロードを許可する

### 要件 2

**ユーザーストーリー:** ユーザーとして、クラウドに保存された領収書を表示したいので、いつでもどこでも領収書を確認できる

#### 受入基準

1. ユーザーが領収書サムネイルをクリックした際、システムはR2から領収書を取得して表示する
2. システムはPresigned URLを使用してセキュアに領収書にアクセスする
3. 領収書の読み込み中、システムはローディング表示を提供する
4. 領収書の取得に失敗した場合、システムは適切なエラーメッセージを表示する
5. システムは画像ファイル（PNG、JPG、JPEG）とPDFファイルの両方を正しく表示する

### 要件 3

**ユーザーストーリー:** 開発者として、R2の認証情報を安全に管理したいので、セキュリティリスクを最小化できる

#### 受入基準

1. システムはR2のアクセスキー、シークレットキー、バケット名を環境変数から読み込む
2. システムは認証情報をソースコードにハードコーディングしない
3. システムは認証情報の検証を起動時に実行する
4. 認証情報が無効な場合、システムは適切なエラーメッセージを表示する
5. システムは認証情報をログに出力しない

### 要件 4

**ユーザーストーリー:** ユーザーとして、領収書のアップロードが高速で信頼性があることを期待するので、ストレスなく領収書管理ができる

#### 受入基準

1. システムは10MB以下のファイルを30秒以内にアップロードする
2. システムはネットワークエラー時に最大3回まで自動リトライする
3. システムはアップロード前にファイルサイズを検証し、制限を超える場合は事前に警告する
4. システムはアップロード中にキャンセル機能を提供する
5. システムは同時に複数ファイルのアップロードをサポートする

### 要件 5

**ユーザーストーリー:** システム管理者として、データベーススキーマを更新したいので、recei
pt_pathからreceipt_urlへの移行を適切に実行できる

#### 受入基準

1. システムはデータベースマイグレーションを実行してreceipt_pathカラムをreceipt_urlに変更する
2. システムは新しいreceipt_urlカラムにHTTPS URL形式の制約を追加する
3. システムはマイグレーション実行前にデータベースのバックアップを作成する
4. マイグレーションが失敗した場合、システムは自動的にロールバックを実行する
5. システムはマイグレーション完了後に新しいスキーマでの動作を検証する

### 要件 6

**ユーザーストーリー:** ユーザーとして、領収書の削除時にクラウドからも確実に削除されることを期待するので、不要なストレージコストを避けられる

#### 受入基準

1. ユーザーが経費エントリを削除する際、システムはR2から対応する領収書ファイルも削除する
2. システムはR2からの削除が完了してからデータベースレコードを削除する
3. R2からの削除に失敗した場合、システムはエラーメッセージを表示し、データベースからは削除しない
4. システムは削除操作に確認ダイアログを表示する
5. システムは削除操作のログを記録する

### 要件 7

**ユーザーストーリー:** 開発者として、R2接続の設定とテストを簡単に行いたいので、開発効率を向上させられる

#### 受入基準

1. システムはR2接続のテスト機能を提供する
2. システムは設定ファイルまたは環境変数でR2エンドポイントを設定可能にする
3. システムは開発環境と本番環境で異なるR2バケットを使用できる
4. システムは接続エラー時に詳細なデバッグ情報を提供する
5. システムはR2の使用量とコストを監視する機能を提供する

### 要件 8

**ユーザーストーリー:** ユーザーとして、オフライン時でも既存の領収書を表示したいので、ネットワーク環境に依存せずアプリを使用できる

#### 受入基準

1. システムは表示済みの領収書をローカルキャッシュに保存する
2. オフライン時、システムはキャッシュされた領収書を表示する
3. システムはキャッシュの有効期限を管理し、古いキャッシュを自動削除する
4. オンライン復帰時、システムはキャッシュを最新版と同期する
5. システムはキャッシュサイズの上限を設定し、超過時は古いファイルから削除する
