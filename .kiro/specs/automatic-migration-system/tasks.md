# 実装計画: 自動マイグレーションシステム

## 概要

アプリケーション起動時に実行されていないマイグレーションを自動で適用するシステムを実装します。既存のマイグレーション機能と統合し、`migrations`テーブルを使用してマイグレーション実行履歴を管理します。

## タスク

- [x] 1. 基本データ構造とエラー型の実装
  - `MigrationDefinition`、`AppliedMigration`、`AutoMigrationResult`等の基本データ構造を定義
  - `MigrationError`エラー型とエラーハンドリング機能を実装
  - _要件: 1.1, 4.1, 6.1_

- [ ]* 1.1 基本データ構造のプロパティテストを作成
  - **プロパティ 9: マイグレーション記録完全性**
  - **検証: 要件 4.1, 4.2, 4.3**

- [x] 2. MigrationTableモジュールの実装
  - `migrations`テーブルの作成・初期化機能を実装
  - 適用済みマイグレーション一覧の取得機能を実装
  - マイグレーション実行記録の保存機能を実装（JST対応）
  - _要件: 1.1, 1.2, 1.3, 4.1, 4.2, 4.3_

- [ ]* 2.1 MigrationTableのプロパティテストを作成
  - **プロパティ 1: migrationsテーブル自動作成**
  - **プロパティ 2: migrationsテーブル冪等性**
  - **検証: 要件 1.1, 1.2, 1.3, 1.4**

- [ ]* 2.2 チェックサム整合性のプロパティテストを作成
  - **プロパティ 10: チェックサム整合性検証**
  - **検証: 要件 4.4**

- [x] 3. MigrationRegistryモジュールの実装
  - マイグレーション定義の登録・管理機能を実装
  - 利用可能なマイグレーション一覧の取得機能を実装
  - マイグレーション名の重複チェック機能を実装
  - チェックサム計算機能を実装
  - _要件: 2.1, 2.4, 4.3_

- [ ]* 3.1 MigrationRegistryのプロパティテストを作成
  - **プロパティ 4: マイグレーション名重複検出**
  - **検証: 要件 2.4**

- [x] 4. MigrationExecutorモジュールの実装
  - マイグレーション実行機能を実装（トランザクション管理含む）
  - バックアップ作成機能を実装
  - エラー時のロールバック機能を実装
  - _要件: 3.3, 6.1, 6.2, 6.3_

- [ ]* 4.1 MigrationExecutorのプロパティテストを作成
  - **プロパティ 6: マイグレーション実行時バックアップ作成**
  - **プロパティ 12: マイグレーションエラー時トランザクション管理**
  - **検証: 要件 3.3, 6.1, 6.2, 6.3**

- [x] 5. 既存マイグレーション機能との統合
  - 既存マイグレーション関数のラッパー実装を作成
  - `BasicSchemaMigrationExecutor`を実装（`run_migrations`統合）
  - `UserAuthMigrationExecutor`を実装（`migrate_user_authentication`統合）
  - `ReceiptUrlMigrationExecutor`を実装（`migrate_receipt_path_to_url`統合）
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ]* 5.1 既存マイグレーション統合のプロパティテストを作成
  - **プロパティ 11: 既存マイグレーション機能統合**
  - **検証: 要件 5.1, 5.2, 5.3, 5.4**

- [x] 6. AutoMigrationServiceメインサービスの実装
  - マイグレーション状態判定機能を実装
  - 未適用マイグレーション一覧の取得機能を実装
  - マイグレーション順次実行機能を実装
  - 並行実行制御機能を実装（データベースロック）
  - _要件: 2.2, 2.3, 3.1, 3.2, 8.3, 8.4_

- [ ]* 6.1 AutoMigrationServiceのプロパティテストを作成
  - **プロパティ 3: マイグレーション状態判定の正確性**
  - **プロパティ 5: マイグレーション実行順序**
  - **プロパティ 15: 並行実行制御**
  - **検証: 要件 2.1, 2.2, 2.3, 3.1, 3.2, 8.3, 8.4**

- [ ] 7. チェックポイント - 基本機能テスト
  - 全てのテストが通ることを確認し、ユーザーに質問があれば尋ねる

- [x] 8. 起動時統合機能の実装
  - `initialize_database`関数への統合コードを実装
  - 起動時自動マイグレーション実行機能を実装
  - マイグレーション失敗時のアプリケーション停止機能を実装
  - _要件: 3.1, 3.4, 3.5_

- [ ]* 8.1 起動時統合のプロパティテストを作成
  - **プロパティ 7: マイグレーション成功時記録保存**
  - **プロパティ 8: マイグレーション失敗時処理**
  - **検証: 要件 3.4, 3.5**

- [x] 9. マイグレーション状態確認コマンドの実装
  - 状態確認用のTauriコマンドを実装
  - 適用済み・未適用マイグレーション一覧表示機能を実装
  - 実行日時・整合性状態表示機能を実装
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ]* 9.1 状態確認コマンドのプロパティテストを作成
  - **プロパティ 13: マイグレーション状態確認出力完全性**
  - **検証: 要件 7.1, 7.2, 7.3, 7.4**

- [ ] 10. パフォーマンス最適化の実装
  - インデックス活用による高速検索機能を実装
  - 必要最小限クエリでの状態判定機能を実装
  - _要件: 8.1, 8.2_

- [ ]* 10.1 パフォーマンス最適化のプロパティテストを作成
  - **プロパティ 14: マイグレーション処理効率性**
  - **検証: 要件 8.1, 8.2**

- [x] 11. 統合テストとドキュメント作成
  - 全体的な統合テストを実装
  - エラーシナリオのテストを実装
  - 使用方法のドキュメントを作成
  - _要件: 全体_

- [ ]* 11.1 統合テストの実装
  - 実際のデータベースを使用した統合テスト
  - エラー条件での動作確認テスト

- [ ] 12. 最終チェックポイント - 全機能テスト
  - 全てのテストが通ることを確認し、ユーザーに質問があれば尋ねる

## 注意事項

- `*`マークのタスクはオプションで、MVPを優先する場合はスキップ可能
- 各タスクは特定の要件を参照し、トレーサビリティを確保
- プロパティテストは最低100回実行で設定
- 既存のマイグレーション機能との互換性を維持
- JST（日本標準時）での日時記録を徹底