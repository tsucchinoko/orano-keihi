name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches:
      - release
      - "release/**"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches:
      - release
      - "release/**"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ã®ç”Ÿæˆ
  version-tag:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      COMMIT_SHORT: ${{ steps.version.outputs.COMMIT_SHORT }}
      TIMESTAMP: ${{ steps.version.outputs.TIMESTAMP }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ
        id: version
        run: |
          # package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          VERSION=$(node -p "require('./packages/desktop/package.json').version")

          # æ—¥æœ¬æ™‚é–“ã§ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y%m%d-%H%M%S')

          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®ç”Ÿæˆ
          RELEASE_TAG="v${VERSION}"

          # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
          COMMIT_SHORT=$(git rev-parse --short HEAD)

          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHORT=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"
          echo "  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${RELEASE_TAG}"
          echo "  - ã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_SHORT}"
          echo "  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}"

  # MacOSãƒ“ãƒ«ãƒ‰ï¼ˆApple Silicon ã®ã¿ï¼‰
  build-macos:
    needs: version-tag
    runs-on: macos-latest  # Apple Silicon (ARM64)
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Apple Developerè¨¼æ˜æ›¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        env:
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "ğŸ” Apple Developerè¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."

          # è¨¼æ˜æ›¸ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12

          # æ–°ã—ã„ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆ
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # è¨¼æ˜æ›¸ã‚’ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸè¨¼æ˜æ›¸ã‚’ç¢ºèª
          security find-identity -v -p codesigning build.keychain

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm certificate.p12

          echo "âœ… Apple Developerè¨¼æ˜æ›¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: è¨¼æ˜æ›¸ã®æ¤œè¨¼ã¨ç½²åIDã®è¨­å®š
        run: |
          echo "ğŸ” è¨¼æ˜æ›¸æƒ…å ±ã‚’ç¢ºèªä¸­..."

          # è¨¼æ˜æ›¸æƒ…å ±ã‚’å–å¾—
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Apple Development\|Developer ID Application")

          if [ -z "$CERT_INFO" ]; then
            echo "âŒ æœ‰åŠ¹ãªè¨¼æ˜æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # è¨¼æ˜æ›¸IDã‚’æŠ½å‡º
          CERT_ID=$(echo "$CERT_INFO" | head -n 1 | awk -F'"' '{print $2}')
          echo "APPLE_SIGNING_IDENTITY=$CERT_ID" >> $GITHUB_ENV

          echo "âœ… è¨¼æ˜æ›¸ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ: $CERT_ID"

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
        run: pnpm build

      - name: MacOSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: pnpm tauri build
        env:
          # Appleç½²åé–¢é€£
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Tauriç½²åé–¢é€£
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒè¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ï¼‰
          ENVIRONMENT: production
          LOG_LEVEL: info
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ - å¿…é ˆï¼‰
          API_SERVER_URL: https://orano-keihi.tsucchinoko.workers.dev
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          API_TIMEOUT_SECONDS: 30
          API_MAX_RETRIES: 3

      - name: Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        run: |
          echo "ğŸ” Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."

          # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ã®.app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          APP_TAR_GZ=$(find . -type f -name "*.app.tar.gz" -path "*/target/release/bundle/macos/*" | head -n 1)

          if [ -z "$APP_TAR_GZ" ]; then
            echo "âŒ .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¢ºèªä¸­..."
            find . -type d -name "macos" -path "*/target/release/bundle/*"
            find . -type f -name "*.app.tar.gz" -o -name "*.tar.gz"
            exit 1
          fi

          # çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
          APP_TAR_GZ_ABS=$(realpath "$APP_TAR_GZ")
          echo "ğŸ“¦ å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: $APP_TAR_GZ_ABS"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:"
          ls -lh "$APP_TAR_GZ_ABS"

          # Apple Silicon (ARM64) ã®ã¿
          ARCH="aarch64"
          echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: $ARCH"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
          VERSION="${{ needs.version-tag.outputs.VERSION }}"

          # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å«ã‚€ï¼‰
          DIR=$(dirname "$APP_TAR_GZ_ABS")
          NEW_FILE_NAME="orano-keihi_${VERSION}_${ARCH}.app.tar.gz"
          NEW_APP_TAR_GZ="${DIR}/${NEW_FILE_NAME}"

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ 
          echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ ä¸­: $NEW_FILE_NAME"
          mv "$APP_TAR_GZ_ABS" "$NEW_APP_TAR_GZ"

          # ç§˜å¯†éµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’å‰Šé™¤ï¼‰
          TEMP_KEY_FILE=$(mktemp)
          echo "$TAURI_SIGNING_PRIVATE_KEY" | tr -d '\n' > "$TEMP_KEY_FILE"
          chmod 600 "$TEMP_KEY_FILE"

          # Tauriç½²åã‚’ç”Ÿæˆ
          cd packages/desktop
          if [ -n "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" ]; then
            pnpm tauri signer sign "$NEW_APP_TAR_GZ" --private-key-path "$TEMP_KEY_FILE" -p "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD"
          else
            pnpm tauri signer sign "$NEW_APP_TAR_GZ" --private-key-path "$TEMP_KEY_FILE"
          fi
          cd ../..

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f "$TEMP_KEY_FILE"

          # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          SIG_FILE="${NEW_APP_TAR_GZ}.sig"
          if [ -f "$SIG_FILE" ]; then
            echo "âœ… ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: $SIG_FILE"
            echo "ğŸ“‹ ç½²åå†…å®¹:"
            cat "$SIG_FILE"
          else
            echo "âŒ ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ãƒªãƒãƒ¼ãƒ ã¨ç½²åãŒå®Œäº†: $NEW_FILE_NAME"
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        run: |
          echo "ğŸ¯ MacOSãƒ“ãƒ«ãƒ‰å®Œäº†"
          echo "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"

          # .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¤œç´¢
          echo "ğŸ” ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ« (.app.tar.gz):"
          find . -type f -name "*.app.tar.gz" -path "*/target/release/bundle/macos/*" -exec ls -lh {} \; 2>/dev/null || {
            echo "âš ï¸ .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          echo "ğŸ” ç½²åãƒ•ã‚¡ã‚¤ãƒ« (.app.tar.gz.sig):"
          find . -type f -name "*.app.tar.gz.sig" -path "*/target/release/bundle/macos/*" -exec ls -lh {} \; 2>/dev/null || {
            echo "âš ï¸ ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          # DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨ï¼‰
          echo "ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨DMG:"
          find . -type f -name "*.dmg" -path "*/target/release/bundle/dmg/*" -exec ls -lh {} \; 2>/dev/null || {
            echo "âš ï¸ DMGãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
          else
            echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
          fi

      - name: MacOSæˆæœç‰©ã®æ•´ç†ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™
        run: |
          echo "ğŸ“¦ MacOSæˆæœç‰©ã‚’æ•´ç†ä¸­..."
          mkdir -p ./macos-artifacts

          # .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          echo "ğŸ” .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          find packages/desktop/src-tauri/target/release/bundle/macos -name "*.app.tar.gz" -type f ! -name "*.sig" -exec cp {} ./macos-artifacts/ \; 2>/dev/null && {
            echo "âœ… .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          } || {
            echo "âš ï¸ .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          # .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          echo "ğŸ” .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          find packages/desktop/src-tauri/target/release/bundle/macos -name "*.app.tar.gz.sig" -type f -exec cp {} ./macos-artifacts/ \; 2>/dev/null && {
            echo "âœ… .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          } || {
            echo "âŒ .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã“ã‚Œã¯å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"
            exit 1
          }

          # DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          echo "ğŸ” DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          find packages/desktop/src-tauri/target/release/bundle/dmg -name "*.dmg" -type f -exec cp {} ./macos-artifacts/ \; 2>/dev/null && {
            echo "âœ… DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          } || {
            echo "âš ï¸ DMGãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          echo "ğŸ“ æ•´ç†ã•ã‚ŒãŸæˆæœç‰©:"
          ls -lh ./macos-artifacts/
          
          # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
          if [ ! -f ./macos-artifacts/*.app.tar.gz.sig ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒæˆæœç‰©ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

      - name: MacOSæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: ./macos-artifacts/
          retention-days: 7

      - name: MacOSç½²åç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          echo "ğŸ§¹ MacOSç½²åç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."

          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’å‰Šé™¤
          security delete-keychain build.keychain 2>/dev/null || true

          # ç’°å¢ƒå¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
          unset APPLE_CERTIFICATE
          unset APPLE_CERTIFICATE_PASSWORD
          unset APPLE_ID
          unset APPLE_ID_PASSWORD
          unset APPLE_TEAM_ID

          echo "âœ… MacOSç½²åç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  # Windowsãƒ“ãƒ«ãƒ‰
  build-windows:
    needs: version-tag
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: dtolnay/rust-toolchain@stable

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
        run: pnpm build

      - name: Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: pnpm tauri build
        env:
          # Tauriç½²åé–¢é€£
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒè¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ï¼‰
          ENVIRONMENT: production
          LOG_LEVEL: info
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ - å¿…é ˆï¼‰
          API_SERVER_URL: https://orano-keihi.tsucchinoko.workers.dev
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          API_TIMEOUT_SECONDS: 30
          API_MAX_RETRIES: 3
          # Windowsç½²åè¨­å®š
          WINDOWS_TIMESTAMP_URL: http://timestamp.digicert.com

      - name: Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆï¼ˆWindowsï¼‰
        run: |
          Write-Host "ğŸ” Windowsç”¨Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."

          # .msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          $msiFiles = Get-ChildItem -Path . -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" -and $_.FullName -notlike "*.msi.zip" }

          if ($msiFiles.Count -eq 0) {
            Write-Host "âŒ .msiãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            Write-Host "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¢ºèªä¸­..."
            Get-ChildItem -Path . -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" } | Select-Object FullName
            exit 1
          }

          $msiFile = $msiFiles[0].FullName
          Write-Host "ğŸ“¦ MSIãƒ•ã‚¡ã‚¤ãƒ«: $msiFile"
          Write-Host "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round((Get-Item $msiFile).Length/1MB, 2)) MB"

          # .msi.zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ï¼‰
          $msiZipFile = "$msiFile.zip"
          Write-Host "ğŸ“¦ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­: $msiZipFile"

          # PowerShellã®åœ§ç¸®ã‚’ä½¿ç”¨
          Compress-Archive -Path $msiFile -DestinationPath $msiZipFile -Force

          Write-Host "âœ… ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
          Write-Host "ğŸ“Š ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round((Get-Item $msiZipFile).Length/1MB, 2)) MB"

          # ç§˜å¯†éµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’å‰Šé™¤ï¼‰
          $tempKeyFile = [System.IO.Path]::GetTempFileName()
          $env:TAURI_SIGNING_PRIVATE_KEY -replace "`n", "" -replace "`r", "" | Out-File -FilePath $tempKeyFile -Encoding ASCII -NoNewline

          try {
            # Tauriç½²åã‚’ç”Ÿæˆ
            Write-Host "ğŸ” ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ç½²åä¸­..."
            Set-Location "packages/desktop"

            if ($env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD) {
              pnpm tauri signer sign "$msiZipFile" --private-key-path "$tempKeyFile" -p "$env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD"
            } else {
              pnpm tauri signer sign "$msiZipFile" --private-key-path "$tempKeyFile"
            }

            Set-Location "../.."

            # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            $sigFile = "$msiZipFile.sig"
            if (Test-Path $sigFile) {
              Write-Host "âœ… ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: $sigFile"
              Write-Host "ğŸ“‹ ç½²åå†…å®¹:"
              Get-Content $sigFile
            } else {
              Write-Host "âŒ ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
            }
          } finally {
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            if (Test-Path $tempKeyFile) {
              Remove-Item $tempKeyFile -Force
            }
          }
        shell: pwsh
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        run: |
          Write-Host "ğŸ¯ Windowsãƒ“ãƒ«ãƒ‰å®Œäº†"
          Write-Host "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"

          # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ« (.msi.zip) ã‚’æ¤œç´¢
          Write-Host "ğŸ” ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ« (.msi.zip):"
          $msiZipFiles = Get-ChildItem -Path . -Filter "*.msi.zip" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" }

          if ($msiZipFiles) {
            foreach ($file in $msiZipFiles) {
              Write-Host "  - $($file.Name) ($([math]::Round($file.Length/1MB, 2)) MB)"
              Write-Host "    å ´æ‰€: $($file.DirectoryName)"
            }
          } else {
            Write-Host "âš ï¸ .msi.zipãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          Write-Host "ğŸ” ç½²åãƒ•ã‚¡ã‚¤ãƒ« (.msi.zip.sig):"
          $sigFiles = Get-ChildItem -Path . -Filter "*.msi.zip.sig" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" }

          if ($sigFiles) {
            foreach ($file in $sigFiles) {
              Write-Host "  - $($file.Name)"
            }
          } else {
            Write-Host "âš ï¸ ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨MSIãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ç¢ºèª
          Write-Host "ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨MSI:"
          $msiFiles = Get-ChildItem -Path . -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" -and $_.FullName -notlike "*.msi.zip" }

          if ($msiFiles) {
            foreach ($file in $msiFiles) {
              Write-Host "  - $($file.Name) ($([math]::Round($file.Length/1MB, 2)) MB)"
            }
          } else {
            Write-Host "âš ï¸ MSIãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }

          if ("${{ github.event_name }}" -eq "pull_request") {
            Write-Host "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
          } else {
            Write-Host "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
          }
        shell: pwsh

      - name: Windowsæˆæœç‰©ã®æ•´ç†ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™
        run: |
          Write-Host "ğŸ“¦ Windowsæˆæœç‰©ã‚’æ•´ç†ä¸­..."
          New-Item -ItemType Directory -Force -Path ./windows-artifacts | Out-Null

          # MSI.zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          $msiZipFiles = Get-ChildItem -Path packages/desktop/src-tauri/target/release/bundle/msi -Filter "*.msi.zip" -ErrorAction SilentlyContinue | Where-Object { $_.Name -notlike "*.sig" }
          if ($msiZipFiles) {
            foreach ($file in $msiZipFiles) {
              Copy-Item $file.FullName -Destination ./windows-artifacts/
              Write-Host "âœ… $($file.Name)ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
            }
          }

          # MSI.zip.sigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          $msiZipSigFiles = Get-ChildItem -Path packages/desktop/src-tauri/target/release/bundle/msi -Filter "*.msi.zip.sig" -ErrorAction SilentlyContinue
          if ($msiZipSigFiles) {
            foreach ($file in $msiZipSigFiles) {
              Copy-Item $file.FullName -Destination ./windows-artifacts/
              Write-Host "âœ… $($file.Name)ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
            }
          }

          # MSIãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ.msi.zipã§ã¯ãªã„ã‚‚ã®ï¼‰
          $msiFiles = Get-ChildItem -Path packages/desktop/src-tauri/target/release/bundle/msi -Filter "*.msi" -ErrorAction SilentlyContinue | Where-Object { $_.Name -notlike "*.zip*" }
          if ($msiFiles) {
            foreach ($file in $msiFiles) {
              Copy-Item $file.FullName -Destination ./windows-artifacts/
              Write-Host "âœ… $($file.Name)ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
            }
          }

          Write-Host "ğŸ“ æ•´ç†ã•ã‚ŒãŸæˆæœç‰©:"
          Get-ChildItem ./windows-artifacts/ | Format-Table Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}
        shell: pwsh

      - name: Windowsæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: ./windows-artifacts/
          retention-days: 7

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release')

    steps:
      - uses: actions/checkout@v4

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæˆæœç‰©ã‚’ç¢ºèªä¸­..."
          echo "=== artifacts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  ==="
          ls -la ./artifacts/ || echo "âŒ artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          if [ -d "./artifacts/macos-artifacts" ]; then
            echo ""
            echo "=== MacOSæˆæœç‰©ï¼ˆApple Siliconï¼‰ ==="
            ls -la ./artifacts/macos-artifacts/
          else
            echo "âš ï¸ MacOSæˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

          if [ -d "./artifacts/windows-artifacts" ]; then
            echo ""
            echo "=== Windowsæˆæœç‰© ==="
            ls -la ./artifacts/windows-artifacts/
          else
            echo "âš ï¸ Windowsæˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        run: |
          echo "ğŸ”§ Tauriè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."

          # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          export VERSION="${{ needs.version-tag.outputs.VERSION }}"
          export RELEASE_TAG="${{ needs.version-tag.outputs.RELEASE_TAG }}"
          export RELEASE_NOTES="ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ needs.version-tag.outputs.VERSION }} ã®ãƒªãƒªãƒ¼ã‚¹"
          export GITHUB_REPOSITORY="${{ github.repository }}"

          # JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          node script/generate-update-manifest.cjs

          echo "âœ… é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ"

          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:"
          if [ -d "update-manifests" ]; then
            ls -la update-manifests/
          else
            echo "âŒ update-manifestsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const version = '${{ needs.version-tag.outputs.VERSION }}';
            const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
            const commitShort = '${{ needs.version-tag.outputs.COMMIT_SHORT }}';

            console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆé–‹å§‹: ' + releaseTag);

            // æˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
            const artifactsDir = './artifacts';
            const macosArtifactsDir = path.join(artifactsDir, 'macos-artifacts');
            const windowsArtifactsDir = path.join(artifactsDir, 'windows-artifacts');

            console.log('ğŸ“ æˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª:');

            if (!fs.existsSync(artifactsDir)) {
              console.error('âŒ artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + artifactsDir);
              throw new Error('artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // åˆ©ç”¨å¯èƒ½ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¡¨ç¤º
            const availableDirs = fs.readdirSync(artifactsDir);
            console.log('   åˆ©ç”¨å¯èƒ½ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ' + availableDirs.join(', '));

            if (!fs.existsSync(macosArtifactsDir)) {
              console.error('âŒ MacOSæˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + macosArtifactsDir);
              throw new Error('MacOSæˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (!fs.existsSync(windowsArtifactsDir)) {
              console.error('âŒ Windowsæˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + windowsArtifactsDir);
              throw new Error('Windowsæˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ï¼‰
            const macosFiles = fs.readdirSync(macosArtifactsDir);
            const windowsFiles = fs.readdirSync(windowsArtifactsDir);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨ãƒ•ã‚¡ã‚¤ãƒ«
            const dmgFiles = macosFiles.filter(f => f.endsWith('.dmg') && !f.endsWith('.dmg.sig'));
            const msiFiles = windowsFiles.filter(f => f.endsWith('.msi') && !f.endsWith('.msi.sig') && !f.endsWith('.msi.zip') && !f.endsWith('.msi.zip.sig'));

            // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«
            const appTarGzFiles = macosFiles.filter(f => f.endsWith('.app.tar.gz') && !f.endsWith('.app.tar.gz.sig'));
            const msiZipFiles = windowsFiles.filter(f => f.endsWith('.msi.zip') && !f.endsWith('.msi.zip.sig'));

            // ç½²åãƒ•ã‚¡ã‚¤ãƒ«
            const appTarGzSigFiles = macosFiles.filter(f => f.endsWith('.app.tar.gz.sig'));
            const msiZipSigFiles = windowsFiles.filter(f => f.endsWith('.msi.zip.sig'));

            console.log('ğŸ“¦ æ¤œå‡ºã•ã‚ŒãŸæˆæœç‰©:');
            console.log('   MacOS DMG: ' + dmgFiles.length + 'å€‹ (' + dmgFiles.join(', ') + ')');
            console.log('   MacOS ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨: ' + appTarGzFiles.length + 'å€‹ (' + appTarGzFiles.join(', ') + ')');
            console.log('   MacOS åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²å: ' + appTarGzSigFiles.length + 'å€‹ (' + appTarGzSigFiles.join(', ') + ')');
            console.log('   Windows MSI: ' + msiFiles.length + 'å€‹ (' + msiFiles.join(', ') + ')');
            console.log('   Windows ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨: ' + msiZipFiles.length + 'å€‹ (' + msiZipFiles.join(', ') + ')');
            console.log('   Windows åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²å: ' + msiZipSigFiles.length + 'å€‹ (' + msiZipSigFiles.join(', ') + ')');

            if (dmgFiles.length === 0) {
              console.error('âŒ DMGãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              console.log('   MacOSãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹: ' + macosFiles.join(', '));
              console.log('   è©³ç´°ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ†æ:');
              macosFiles.forEach(f => {
                const fullPath = path.join(macosArtifactsDir, f);
                const stats = fs.statSync(fullPath);
                console.log('     - ' + f + ' (' + (stats.isDirectory() ? 'ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª' : 'ãƒ•ã‚¡ã‚¤ãƒ« ' + (stats.size / 1024 / 1024).toFixed(2) + ' MB') + ')');
              });
              throw new Error('DMGãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (appTarGzFiles.length === 0) {
              console.error('âŒ .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              console.log('   MacOSãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹: ' + macosFiles.join(', '));
              throw new Error('.app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (msiFiles.length === 0) {
              console.error('âŒ MSIãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              console.log('   Windowsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹: ' + windowsFiles.join(', '));
              throw new Error('MSIãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (msiZipFiles.length === 0) {
              console.error('âŒ .msi.zipãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              console.log('   Windowsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹: ' + windowsFiles.join(', '));
              throw new Error('.msi.zipãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨ã‚µã‚¤ã‚ºã®å–å¾—
            const msiPath = path.join(windowsArtifactsDir, msiFiles[0]);
            const msiStats = fs.statSync(msiPath);
            const msiSizeMB = (msiStats.size / 1024 / 1024).toFixed(2);

            console.log('ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:');
            
            // MacOS DMGãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºæƒ…å ±
            const dmgInfoList = dmgFiles.map(dmgFile => {
              const dmgPath = path.join(macosArtifactsDir, dmgFile);
              const dmgStats = fs.statSync(dmgPath);
              const dmgSizeMB = (dmgStats.size / 1024 / 1024).toFixed(2);
              console.log('   - MacOS DMG: ' + dmgFile + ' (' + dmgSizeMB + ' MB)');
              return { file: dmgFile, size: dmgSizeMB };
            });
            
            console.log('   - Windows MSI: ' + msiFiles[0] + ' (' + msiSizeMB + ' MB)');

            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
            const dmgTableRows = dmgInfoList.map(info => 
              '| **MacOS (Apple Silicon)** | ' + info.file + ' | ' + info.size + ' MB |'
            ).join('\n');
            
            const releaseNotes = [
              '## ğŸ‰ æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹: ' + releaseTag,
              '',
              '### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '| ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º |',
              '|---|---|---|',
              dmgTableRows,
              '| **Windows** | ' + msiFiles[0] + ' | ' + msiSizeMB + ' MB |',
              '',
              '### ğŸ”„ è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ',
              'ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€Tauriè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ç”¨ã®é™çš„JSONãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š',
              '- `darwin-aarch64.json` - macOS Apple Siliconç”¨',
              '- `windows-x86_64.json` - Windows 64bitç”¨',
              '',
              'æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯è‡ªå‹•çš„ã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’é€šçŸ¥ã—ã¾ã™ã€‚',
              '',
              '### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±',
              '- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ' + version,
              '- **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°**: ' + releaseTag,
              '- **ã‚³ãƒŸãƒƒãƒˆ**: ' + context.sha + ' (' + commitShort + ')',
              '- **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (JST)',
              '- **ãƒ“ãƒ«ãƒ‰è€…**: ' + context.actor,
              '',
              '### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•',
              '',
              '#### MacOS',
              '1. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆApple Siliconå°‚ç”¨ï¼‰',
              '2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ',
              '3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—',
              '',
              '**æ³¨æ„**: ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯Apple Silicon (M1/M2/M3) Macå°‚ç”¨ã§ã™ã€‚',
              '',
              '#### Windows',
              '1. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '2. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€ã‚’é¸æŠ',
              '3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
            ].join('\n');

            // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
            console.log('ğŸ“ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              name: 'ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ' + releaseTag,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });

            console.log('âœ… ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ' + release.data.html_url);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°
            async function uploadFile(filePath, fileName, description) {
              try {
                console.log('ğŸ“¤ ' + description + 'ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ' + fileName);
                const fileContent = fs.readFileSync(filePath);
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: fileName,
                  data: fileContent
                });
                console.log('âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ' + fileName);
              } catch (error) {
                console.error('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + fileName + ' - ' + error.message);
                throw error;
              }
            }

            // MacOS DMGãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨ - å…¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
            for (const dmgFile of dmgFiles) {
              const dmgPath = path.join(macosArtifactsDir, dmgFile);
              await uploadFile(dmgPath, dmgFile, 'MacOS DMGãƒ•ã‚¡ã‚¤ãƒ«');
            }

            // MacOS ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
            if (appTarGzFiles.length > 0) {
              for (const appTarGzFile of appTarGzFiles) {
                const appTarGzPath = path.join(macosArtifactsDir, appTarGzFile);
                await uploadFile(appTarGzPath, appTarGzFile, 'MacOS ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ« (.app.tar.gz)');
              }
            } else {
              console.error('âŒ MacOS .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              throw new Error('MacOS .app.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // MacOS åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²åã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
            if (appTarGzSigFiles.length > 0) {
              for (const appTarGzSigFile of appTarGzSigFiles) {
                const appTarGzSigPath = path.join(macosArtifactsDir, appTarGzSigFile);
                await uploadFile(appTarGzSigPath, appTarGzSigFile, 'MacOS åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²å');
              }
            } else {
              console.error('âŒ MacOS .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              throw new Error('MacOS .app.tar.gz.sigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // Windows MSIãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é…å¸ƒç”¨ï¼‰
            await uploadFile(msiPath, msiFiles[0], 'Windows MSIãƒ•ã‚¡ã‚¤ãƒ«');

            // Windows ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            if (msiZipFiles.length > 0) {
              const msiZipPath = path.join(windowsArtifactsDir, msiZipFiles[0]);
              await uploadFile(msiZipPath, msiZipFiles[0], 'Windows ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ« (.msi.zip)');
            } else {
              console.warn('âš ï¸  Windows .msi.zipãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // Windows åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²åã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            if (msiZipSigFiles.length > 0) {
              const msiZipSigPath = path.join(windowsArtifactsDir, msiZipSigFiles[0]);
              await uploadFile(msiZipSigPath, msiZipSigFiles[0], 'Windows åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ç½²å');
            } else {
              console.warn('âš ï¸  Windows .msi.zip.sigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            console.log('ğŸ“¤ é™çš„JSONãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            const manifestDir = './update-manifests';
            if (fs.existsSync(manifestDir)) {
              const manifestFiles = fs.readdirSync(manifestDir).filter(f => f.endsWith('.json'));

              for (const manifestFile of manifestFiles) {
                const manifestPath = path.join(manifestDir, manifestFile);
                await uploadFile(manifestPath, manifestFile, 'ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«');
              }

              console.log('âœ… ' + manifestFiles.length + 'å€‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            } else {
              console.warn('âš ï¸  ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + manifestDir);
            }

            console.log('ğŸ‰ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼');
            console.log('ğŸ”— ãƒªãƒªãƒ¼ã‚¹URL: ' + release.data.html_url);

  # ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼ï¼ˆPRç”¨ï¼‰
  build-summary:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.version-tag.outputs.VERSION }}';
            const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
            const macosResult = '${{ needs.build-macos.result }}';
            const windowsResult = '${{ needs.build-windows.result }}';
            const eventName = '${{ github.event_name }}';

            console.log('='.repeat(60));
            console.log('ğŸ¯ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰çµæœã‚µãƒãƒªãƒ¼');
            console.log('='.repeat(60));
            console.log('');
            console.log('ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±:');
            console.log('  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ' + version);
            console.log('  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ' + releaseTag);
            console.log('  - ã‚¤ãƒ™ãƒ³ãƒˆ: ' + eventName);
            console.log('');
            console.log('ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœ:');
            console.log('  - MacOS: ' + (macosResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
            console.log('  - Windows: ' + (windowsResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
            console.log('');

            if (eventName === 'pull_request') {
              console.log('ğŸ“ PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ:');
              console.log('  âœ… ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
              console.log('  â„¹ï¸  ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ï¼ˆPRç”¨ãƒ†ã‚¹ãƒˆï¼‰');
              console.log('  ğŸ’¡ releaseãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸å¾Œã€è‡ªå‹•çš„ã«ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™');
            } else if (macosResult === 'success' && windowsResult === 'success') {
              console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ:');
              console.log('  âœ… ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ');
              console.log('  ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ä½œæˆã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã™');
            } else {
              console.log('âš ï¸  ãƒ“ãƒ«ãƒ‰å¤±æ•—:');
              console.log('  âŒ ä¸€éƒ¨ã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“');
            }

            console.log('');
            console.log('='.repeat(60));
