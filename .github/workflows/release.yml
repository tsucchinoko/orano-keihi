name: MacOS Release Build

# mainブランチプッシュ時にトリガー
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 環境変数の設定
env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    # MacOSランナー環境の設定
    runs-on: macos-latest
    
    steps:
    - name: リポジトリのチェックアウト
      uses: actions/checkout@v4
      
    - name: ビルド情報の出力
      run: |
        echo "ビルド開始: $(date)"
        echo "コミットハッシュ: ${{ github.sha }}"
        echo "ブランチ: ${{ github.ref_name }}"
        
    # Node.js/Deno環境セットアップ
    - name: Denoのセットアップ
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x
        
    - name: Denoキャッシュの設定
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/deno
          ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-
          
    - name: フロントエンド依存関係のインストール
      run: |
        echo "Denoの依存関係を確認中..."
        deno --version
        
    - name: フロントエンドビルドの実行
      run: |
        echo "フロントエンドビルドを開始..."
        deno task build
        
    # Rust環境セットアップ
    - name: Rustツールチェーンのセットアップ
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Tauri CLIのインストール
      run: |
        cargo install tauri-cli --version "^2.0" --locked
        
    - name: Cargoキャッシュの設定
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Tauriビルド環境の準備
      run: |
        echo "Rustバージョン確認..."
        rustc --version
        cargo --version
        echo "Tauriビルド環境を準備中..."
        # Tauriの依存関係を事前にチェック
        cd src-tauri
        cargo check
        
    # Tauriアプリケーションビルド
    - name: Tauriアプリケーションのビルド
      run: |
        echo "Tauriアプリケーションビルドを開始..."
        cd src-tauri
        cargo tauri build --verbose
      env:
        RUST_BACKTRACE: 1
        RUST_LOG: debug
        
    - name: ビルド成果物の確認
      run: |
        echo "ビルド成果物を確認中..."
        find src-tauri/target/release/bundle -name "*.dmg" -type f
        ls -la src-tauri/target/release/bundle/dmg/ || echo "dmgディレクトリが見つかりません"
        
    # dmgファイルの成果物アップロード
    - name: dmgファイルのアップロード
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-${{ github.sha }}
        path: src-tauri/target/release/bundle/dmg/*.dmg
        if-no-files-found: error
        retention-days: 30
        
    - name: ビルド失敗時のログ収集
      if: failure()
      run: |
        echo "ビルドが失敗しました。詳細ログを収集中..."
        echo "=== Cargo ビルドログ ==="
        find src-tauri/target -name "*.log" -type f -exec cat {} \; || echo "ログファイルが見つかりません"
        echo "=== 環境情報 ==="
        rustc --version
        cargo --version
        deno --version
        echo "=== ディスク使用量 ==="
        df -h
        echo "=== メモリ使用量 ==="
        free -h || vm_stat
        
    - name: ビルド完了通知
      if: success()
      run: |
        echo "ビルド完了: $(date)"
        echo "成果物がアップロードされました"