name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: |
          ~/.pnpm-store
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-deps-${{ hashFiles('**/pnpm-lock.yaml', '**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-deps-
        
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install --frozen-lockfile
        
    - name: Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: |
        echo "MacOSç”¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        pnpm build
        echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
        ls -la build/
        
    - name: Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        echo "MacOSç”¨Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰
        export TAURI_ENV=production
        if ! pnpm tauri build --bundles dmg --verbose; then
          echo "âŒ MacOSãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          exit 1
        fi
        echo "âœ… MacOSãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      run: |
        echo "MacOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç¢ºèªä¸­..."
        DMG_FILES=$(find src-tauri/target/release/bundle -name "*.dmg" -type f)
        if [ -z "$DMG_FILES" ]; then
          echo "âŒ dmgãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… è¦‹ã¤ã‹ã£ãŸdmgãƒ•ã‚¡ã‚¤ãƒ«:"
        echo "$DMG_FILES"

        
    - name: dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-${{ github.sha }}
        path: src-tauri/target/release/bundle/dmg/*.dmg
        if-no-files-found: error
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: |
          ~/.pnpm-store
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-deps-${{ hashFiles('**/pnpm-lock.yaml', '**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-deps-
        
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install --frozen-lockfile
        
    - name: Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Windowsç”¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        pnpm build
        echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
        Get-ChildItem -Path "build" -Recurse
        
    - name: Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Windowsç”¨Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰
        $env:TAURI_ENV = "production"
        try {
          pnpm tauri build --bundles msi --verbose
          echo "âœ… Windowsãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        } catch {
          echo "âŒ Windowsãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          exit 1
        }
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      run: |
        echo "Windowsãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç¢ºèªä¸­..."
        $msiFiles = Get-ChildItem -Path "src-tauri/target/release/bundle" -Recurse -Filter "*.msi"
        if ($msiFiles.Count -eq 0) {
          echo "âŒ msiãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        }
        echo "âœ… è¦‹ã¤ã‹ã£ãŸmsiãƒ•ã‚¡ã‚¤ãƒ«:"
        $msiFiles | ForEach-Object { echo $_.FullName }

        
    - name: msiãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: windows-msi-${{ github.sha }}
        path: src-tauri/target/release/bundle/msi/*.msi
        if-no-files-found: error
        retention-days: 30

  create-release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: success() && github.ref_name == 'main' && github.event_name == 'push'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: MacOSæˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: macos-dmg-${{ github.sha }}
        path: ./artifacts/macos/
        
    - name: Windowsæˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: windows-msi-${{ github.sha }}
        path: ./artifacts/windows/
        
    - name: æˆæœç‰©ã®ç¢ºèª
      run: |
        echo "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸæˆæœç‰©ã‚’ç¢ºèªä¸­..."
        find ./artifacts -type f -name "*.dmg" -o -name "*.msi"
        
    - name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const version = packageJson.version;
          const releaseTag = `v${version}`;
          const releaseName = `ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ${releaseTag}`;
          
          // æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
          const { execSync } = require('child_process');
          const dmgFiles = execSync('find ./artifacts/macos -name "*.dmg" -type f').toString().trim().split('\n').filter(f => f);
          const msiFiles = execSync('find ./artifacts/windows -name "*.msi" -type f').toString().trim().split('\n').filter(f => f);
          
          if (dmgFiles.length === 0 || msiFiles.length === 0) {
            throw new Error('å¿…è¦ãªæˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          const dmgPath = dmgFiles[0];
          const msiPath = msiFiles[0];
          const dmgName = path.basename(dmgPath);
          const msiName = path.basename(msiPath);
          
          // æ—¢å­˜ãƒªãƒªãƒ¼ã‚¹ã®ç¢ºèª
          try {
            const existingRelease = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: releaseTag
            });
            console.log(`æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            return;
          } catch (error) {
            console.log(`æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ã‚’ä½œæˆã—ã¾ã™`);
          }
          
          // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          const releaseNotes = `## ğŸ‰ æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹: ${releaseTag}

          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **MacOS**: ${dmgName}
          - **Windows**: ${msiName}

          ### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±
          - **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha}
          - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ${new Date().toISOString()}
          - **ãƒ“ãƒ«ãƒ‰è€…**: ${context.actor}

          ### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          #### MacOS
          1. ${dmgName}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ
          3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
          4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•

          #### Windows
          1. ${msiName}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ
          3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          4. ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•

          ### âš ï¸ æ³¨æ„äº‹é …
          - **MacOS**: åˆå›èµ·å‹•æ™‚ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒè¨­å®š > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„
          - **Windows**: SmartScreenã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã€Œè©³ç´°æƒ…å ±ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œå®Ÿè¡Œã€ã‚’é¸æŠã—ã¦ãã ã•ã„`;
          
          // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: releaseTag,
            name: releaseName,
            body: releaseNotes,
            draft: false,
            prerelease: false
          });
          
          // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          const dmgContent = fs.readFileSync(dmgPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: dmgName,
            data: dmgContent
          });
          
          // msiãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          const msiContent = fs.readFileSync(msiPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: msiName,
            data: msiContent
          });
          
          console.log(`ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ`);
          console.log(`URL: ${release.data.html_url}`);