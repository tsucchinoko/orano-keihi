name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ã®ç”Ÿæˆ
  version-tag:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      COMMIT_SHORT: ${{ steps.version.outputs.COMMIT_SHORT }}
      TIMESTAMP: ${{ steps.version.outputs.TIMESTAMP }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ
      id: version
      run: |
        # package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        VERSION=$(node -p "require('./package.json').version")
        
        # æ—¥æœ¬æ™‚é–“ã§ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ
        TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y%m%d-%H%M%S')
        
        # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®ç”Ÿæˆ
        RELEASE_TAG="v${VERSION}-${TIMESTAMP}"
        
        # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        echo "COMMIT_SHORT=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:"
        echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"
        echo "  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${RELEASE_TAG}"
        echo "  - ã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_SHORT}"
        echo "  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}"

  # MacOSãƒ“ãƒ«ãƒ‰
  build-macos:
    needs: version-tag
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: pnpm/action-setup@v4
      with:
        version: 8
    
    - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: pnpm build
    
    - name: MacOSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: pnpm tauri build
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    
    - name: MacOSæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: macos-artifacts
        path: src-tauri/target/release/bundle/dmg/*.dmg
        retention-days: 7

  # Windowsãƒ“ãƒ«ãƒ‰
  build-windows:
    needs: version-tag
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: pnpm/action-setup@v4
      with:
        version: 8
    
    - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: pnpm build
    
    - name: Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: pnpm tauri build
    
    - name: Windowsæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: src-tauri/target/release/bundle/msi/*.msi
        retention-days: 7

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const version = '${{ needs.version-tag.outputs.VERSION }}';
          const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
          const commitShort = '${{ needs.version-tag.outputs.COMMIT_SHORT }}';
          
          console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆé–‹å§‹: ' + releaseTag);
          
          // æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
          const dmgFiles = fs.readdirSync('./artifacts/macos-artifacts').filter(f => f.endsWith('.dmg'));
          const msiFiles = fs.readdirSync('./artifacts/windows-artifacts').filter(f => f.endsWith('.msi'));
          
          if (dmgFiles.length === 0 || msiFiles.length === 0) {
            throw new Error('å¿…è¦ãªæˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          const dmgPath = path.join('./artifacts/macos-artifacts', dmgFiles[0]);
          const msiPath = path.join('./artifacts/windows-artifacts', msiFiles[0]);
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å–å¾—
          const dmgStats = fs.statSync(dmgPath);
          const msiStats = fs.statSync(msiPath);
          const dmgSizeMB = (dmgStats.size / 1024 / 1024).toFixed(2);
          const msiSizeMB = (msiStats.size / 1024 / 1024).toFixed(2);
          
          console.log('ğŸ“¦ æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«:');
          console.log('  - MacOS: ' + dmgFiles[0] + ' (' + dmgSizeMB + ' MB)');
          console.log('  - Windows: ' + msiFiles[0] + ' (' + msiSizeMB + ' MB)');
          
          // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          const releaseNotes = [
            '## ğŸ‰ æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹: ' + releaseTag,
            '',
            '### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '| ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º |',
            '|---|---|---|',
            '| **MacOS** | ' + dmgFiles[0] + ' | ' + dmgSizeMB + ' MB |',
            '| **Windows** | ' + msiFiles[0] + ' | ' + msiSizeMB + ' MB |',
            '',
            '### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±',
            '- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ' + version,
            '- **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°**: ' + releaseTag,
            '- **ã‚³ãƒŸãƒƒãƒˆ**: ' + context.sha + ' (' + commitShort + ')',
            '- **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (JST)',
            '- **ãƒ“ãƒ«ãƒ‰è€…**: ' + context.actor,
            '',
            '### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•',
            '',
            '#### MacOS',
            '1. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ',
            '3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—',
            '',
            '#### Windows',
            '1. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '2. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€ã‚’é¸æŠ',
            '3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
          ].join('\n');
          
          // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          console.log('ğŸ“ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: releaseTag,
            name: 'ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ' + releaseTag,
            body: releaseNotes,
            draft: false,
            prerelease: false
          });
          
          console.log('âœ… ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ' + release.data.html_url);
          
          // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          console.log('ğŸ“¤ MacOS dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          const dmgContent = fs.readFileSync(dmgPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: dmgFiles[0],
            data: dmgContent
          });
          
          // msiãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          console.log('ğŸ“¤ Windows msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          const msiContent = fs.readFileSync(msiPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: msiFiles[0],
            data: msiContent
          });
          
          console.log('ğŸ‰ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼');
          console.log('ğŸ”— ãƒªãƒªãƒ¼ã‚¹URL: ' + release.data.html_url);