name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ã®ç”Ÿæˆ
  version-tag:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      COMMIT_SHORT: ${{ steps.version.outputs.COMMIT_SHORT }}
      TIMESTAMP: ${{ steps.version.outputs.TIMESTAMP }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ
      id: version
      run: |
        # package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        VERSION=$(node -p "require('./package.json').version")
        
        # æ—¥æœ¬æ™‚é–“ã§ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ
        TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y%m%d-%H%M%S')
        
        # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®ç”Ÿæˆ
        RELEASE_TAG="v${VERSION}-${TIMESTAMP}"
        
        # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        echo "COMMIT_SHORT=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:"
        echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"
        echo "  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${RELEASE_TAG}"
        echo "  - ã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_SHORT}"
        echo "  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}"

  # MacOSãƒ“ãƒ«ãƒ‰
  build-macos:
    needs: version-tag
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'pnpm'
    
    - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: pnpm build
    
    - name: MacOSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: pnpm tauri build
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    
    - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
      run: |
        echo "ğŸ¯ MacOSãƒ“ãƒ«ãƒ‰å®Œäº†"
        echo "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        find src-tauri/target/release/bundle/dmg -name "*.dmg" -exec ls -lh {} \; || echo "dmgãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
        else
          echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
        fi
    
    - name: MacOSæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: macos-artifacts
        path: src-tauri/target/release/bundle/dmg/*.dmg
        retention-days: 7

  # Windowsãƒ“ãƒ«ãƒ‰
  build-windows:
    needs: version-tag
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'pnpm'
    
    - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
      run: pnpm build
    
    - name: Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: pnpm tauri build
    
    - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
      run: |
        echo "ğŸ¯ Windowsãƒ“ãƒ«ãƒ‰å®Œäº†"
        echo "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        Get-ChildItem -Path "src-tauri/target/release/bundle/msi" -Filter "*.msi" | ForEach-Object { 
          Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
        }
        
        if ("${{ github.event_name }}" -eq "pull_request") {
          echo "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
        } else {
          echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
        }
      shell: pwsh
    
    - name: Windowsæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: src-tauri/target/release/bundle/msi/*.msi
        retention-days: 7

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const version = '${{ needs.version-tag.outputs.VERSION }}';
          const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
          const commitShort = '${{ needs.version-tag.outputs.COMMIT_SHORT }}';
          
          console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆé–‹å§‹: ' + releaseTag);
          
          // æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
          const dmgFiles = fs.readdirSync('./artifacts/macos-artifacts').filter(f => f.endsWith('.dmg'));
          const msiFiles = fs.readdirSync('./artifacts/windows-artifacts').filter(f => f.endsWith('.msi'));
          
          if (dmgFiles.length === 0 || msiFiles.length === 0) {
            throw new Error('å¿…è¦ãªæˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          const dmgPath = path.join('./artifacts/macos-artifacts', dmgFiles[0]);
          const msiPath = path.join('./artifacts/windows-artifacts', msiFiles[0]);
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å–å¾—
          const dmgStats = fs.statSync(dmgPath);
          const msiStats = fs.statSync(msiPath);
          const dmgSizeMB = (dmgStats.size / 1024 / 1024).toFixed(2);
          const msiSizeMB = (msiStats.size / 1024 / 1024).toFixed(2);
          
          console.log('ğŸ“¦ æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«:');
          console.log('  - MacOS: ' + dmgFiles[0] + ' (' + dmgSizeMB + ' MB)');
          console.log('  - Windows: ' + msiFiles[0] + ' (' + msiSizeMB + ' MB)');
          
          // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          const releaseNotes = [
            '## ğŸ‰ æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹: ' + releaseTag,
            '',
            '### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '| ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º |',
            '|---|---|---|',
            '| **MacOS** | ' + dmgFiles[0] + ' | ' + dmgSizeMB + ' MB |',
            '| **Windows** | ' + msiFiles[0] + ' | ' + msiSizeMB + ' MB |',
            '',
            '### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±',
            '- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ' + version,
            '- **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°**: ' + releaseTag,
            '- **ã‚³ãƒŸãƒƒãƒˆ**: ' + context.sha + ' (' + commitShort + ')',
            '- **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (JST)',
            '- **ãƒ“ãƒ«ãƒ‰è€…**: ' + context.actor,
            '',
            '### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•',
            '',
            '#### MacOS',
            '1. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ',
            '3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—',
            '',
            '#### Windows',
            '1. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            '2. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€ã‚’é¸æŠ',
            '3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
          ].join('\n');
          
          // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          console.log('ğŸ“ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: releaseTag,
            name: 'ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ' + releaseTag,
            body: releaseNotes,
            draft: false,
            prerelease: false
          });
          
          console.log('âœ… ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ' + release.data.html_url);
          
          // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          console.log('ğŸ“¤ MacOS dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          const dmgContent = fs.readFileSync(dmgPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: dmgFiles[0],
            data: dmgContent
          });
          
          // msiãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          console.log('ğŸ“¤ Windows msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          const msiContent = fs.readFileSync(msiPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: msiFiles[0],
            data: msiContent
          });
          
          console.log('ğŸ‰ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼');
          console.log('ğŸ”— ãƒªãƒªãƒ¼ã‚¹URL: ' + release.data.html_url);


  # ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼ï¼ˆPRç”¨ï¼‰
  build-summary:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const version = '${{ needs.version-tag.outputs.VERSION }}';
          const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
          const macosResult = '${{ needs.build-macos.result }}';
          const windowsResult = '${{ needs.build-windows.result }}';
          const eventName = '${{ github.event_name }}';
          
          console.log('='.repeat(60));
          console.log('ğŸ¯ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰çµæœã‚µãƒãƒªãƒ¼');
          console.log('='.repeat(60));
          console.log('');
          console.log('ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±:');
          console.log('  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ' + version);
          console.log('  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ' + releaseTag);
          console.log('  - ã‚¤ãƒ™ãƒ³ãƒˆ: ' + eventName);
          console.log('');
          console.log('ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœ:');
          console.log('  - MacOS: ' + (macosResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
          console.log('  - Windows: ' + (windowsResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
          console.log('');
          
          if (eventName === 'pull_request') {
            console.log('ğŸ“ PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ:');
            console.log('  âœ… ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            console.log('  â„¹ï¸  ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ï¼ˆPRç”¨ãƒ†ã‚¹ãƒˆï¼‰');
            console.log('  ğŸ’¡ mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸å¾Œã€è‡ªå‹•çš„ã«ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™');
          } else if (macosResult === 'success' && windowsResult === 'success') {
            console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ:');
            console.log('  âœ… ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ');
            console.log('  ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ä½œæˆã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã™');
          } else {
            console.log('âš ï¸  ãƒ“ãƒ«ãƒ‰å¤±æ•—:');
            console.log('  âŒ ä¸€éƒ¨ã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“');
          }
          
          console.log('');
          console.log('='.repeat(60));
