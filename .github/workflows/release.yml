name: MacOS Release Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pnpm install --no-frozen-lockfile
        
    - name: Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Tauriã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        pnpm tauri build --bundles dmg
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      run: |
        echo "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç¢ºèªä¸­..."
        find src-tauri/target/release/bundle -name "*.dmg" -type f

        
    - name: dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-${{ github.sha }}
        path: src-tauri/target/release/bundle/dmg/*.dmg
        if-no-files-found: error
        retention-days: 30
        
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
      if: success() && github.ref_name == 'main' && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          const fs = require('fs');
          const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const version = packageJson.version;
          const releaseTag = `v${version}`;
          const releaseName = `ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ${releaseTag}`;
          
          // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
          const { execSync } = require('child_process');
          const dmgPath = execSync('find src-tauri/target/release/bundle/dmg -name "*.dmg" -type f | head -1').toString().trim();
          const dmgName = dmgPath.split('/').pop();
          
          // æ—¢å­˜ãƒªãƒªãƒ¼ã‚¹ã®ç¢ºèª
          try {
            const existingRelease = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: releaseTag
            });
            console.log(`æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            return;
          } catch (error) {
            console.log(`æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ã‚’ä½œæˆã—ã¾ã™`);
          }
          
          // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          const releaseNotes = `## ğŸ‰ æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹: ${releaseTag}

          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **MacOS**: ${dmgName}

          ### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±
          - **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha}
          - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ${new Date().toISOString()}
          - **ãƒ“ãƒ«ãƒ‰è€…**: ${context.actor}

          ### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. ä¸Šè¨˜ã®dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ
          3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
          4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•

          ### âš ï¸ æ³¨æ„äº‹é …
          - åˆå›èµ·å‹•æ™‚ã«macOSã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
          - ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒè¨­å®š > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„`;
          
          // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: releaseTag,
            name: releaseName,
            body: releaseNotes,
            draft: false,
            prerelease: false
          });
          
          // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          const dmgContent = fs.readFileSync(dmgPath);
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.data.id,
            name: dmgName,
            data: dmgContent
          });
          
          console.log(`ãƒªãƒªãƒ¼ã‚¹ ${releaseTag} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ`);
          console.log(`URL: ${release.data.html_url}`);