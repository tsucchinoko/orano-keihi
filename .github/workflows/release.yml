name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches:
      - release
      - "release/**"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches:
      - release
      - "release/**"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ã®ç”Ÿæˆ
  version-tag:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      COMMIT_SHORT: ${{ steps.version.outputs.COMMIT_SHORT }}
      TIMESTAMP: ${{ steps.version.outputs.TIMESTAMP }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ
        id: version
        run: |
          # package.jsonã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          VERSION=$(node -p "require('./packages/desktop/package.json').version")

          # æ—¥æœ¬æ™‚é–“ã§ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y%m%d-%H%M%S')

          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®ç”Ÿæˆ
          RELEASE_TAG="v${VERSION}-${TIMESTAMP}"

          # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
          COMMIT_SHORT=$(git rev-parse --short HEAD)

          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHORT=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"
          echo "  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${RELEASE_TAG}"
          echo "  - ã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_SHORT}"
          echo "  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}"

  # MacOSãƒ“ãƒ«ãƒ‰
  build-macos:
    needs: version-tag
    runs-on: macos-latest
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: dtolnay/rust-toolchain@stable

      - name: Apple Developerè¨¼æ˜æ›¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        env:
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "ğŸ” Apple Developerè¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."

          # è¨¼æ˜æ›¸ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12

          # æ–°ã—ã„ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆ
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # è¨¼æ˜æ›¸ã‚’ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸè¨¼æ˜æ›¸ã‚’ç¢ºèª
          security find-identity -v -p codesigning build.keychain

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm certificate.p12

          echo "âœ… Apple Developerè¨¼æ˜æ›¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: è¨¼æ˜æ›¸ã®æ¤œè¨¼ã¨ç½²åIDã®è¨­å®š
        run: |
          echo "ğŸ” è¨¼æ˜æ›¸æƒ…å ±ã‚’ç¢ºèªä¸­..."

          # è¨¼æ˜æ›¸æƒ…å ±ã‚’å–å¾—
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Apple Development\|Developer ID Application")

          if [ -z "$CERT_INFO" ]; then
            echo "âŒ æœ‰åŠ¹ãªè¨¼æ˜æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # è¨¼æ˜æ›¸IDã‚’æŠ½å‡º
          CERT_ID=$(echo "$CERT_INFO" | head -n 1 | awk -F'"' '{print $2}')
          echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV

          echo "âœ… è¨¼æ˜æ›¸ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ: $CERT_ID"

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
        run: pnpm build

      - name: MacOSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: pnpm tauri build
        env:
          # Appleç½²åé–¢é€£ï¼ˆå‹•çš„ã«å–å¾—ã—ãŸè¨¼æ˜æ›¸IDã‚’ä½¿ç”¨ï¼‰
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Tauriç½²åé–¢é€£
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒè¨­å®š
          ENVIRONMENT: production
          DEBUG: false
          LOG_LEVEL: info
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
          API_SERVER_URL: https://orano-keihi.tsucchinoko.workers.dev
          API_TIMEOUT_SECONDS: 30
          API_MAX_RETRIES: 3
          # Google OAuth 2.0è¨­å®š
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: http://127.0.0.1/callback
          # ã‚»ãƒƒã‚·ãƒ§ãƒ³æš—å·åŒ–ã‚­ãƒ¼
          SESSION_ENCRYPTION_KEY: ${{ secrets.SESSION_ENCRYPTION_KEY }}

      - name: Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        run: |
          echo "ğŸ” Tauriç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."

          # DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆãƒ¢ãƒãƒ¬ãƒæ§‹é€ ã«å¯¾å¿œï¼‰
          DMG_FILE=$(find . -type f -name "*.dmg" -path "*/target/release/bundle/dmg/*" | head -n 1)

          if [ -z "$DMG_FILE" ]; then
            echo "âŒ DMGãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
          DMG_FILE_ABS=$(realpath "$DMG_FILE")
          echo "ğŸ“¦ ç½²åå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $DMG_FILE_ABS"

          # ç§˜å¯†éµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          TEMP_KEY_FILE=$(mktemp)
          echo "$TAURI_SIGNING_PRIVATE_KEY" > "$TEMP_KEY_FILE"
          chmod 600 "$TEMP_KEY_FILE"

          # Tauriç½²åã‚’ç”Ÿæˆ
          cd packages/desktop
          if [ -n "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" ]; then
            pnpm tauri signer sign "$DMG_FILE_ABS" --private-key-path "$TEMP_KEY_FILE" -p "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD"
          else
            pnpm tauri signer sign "$DMG_FILE_ABS" --private-key-path "$TEMP_KEY_FILE"
          fi
          cd ../..

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f "$TEMP_KEY_FILE"

          # ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          SIG_FILE="${DMG_FILE_ABS}.sig"
          if [ -f "$SIG_FILE" ]; then
            echo "âœ… ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: $SIG_FILE"
            echo "ğŸ“‹ ç½²åå†…å®¹:"
            cat "$SIG_FILE"
          else
            echo "âŒ ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        run: |
          echo "ğŸ¯ MacOSãƒ“ãƒ«ãƒ‰å®Œäº†"
          echo "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"

          # dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¤œç´¢
          find . -type f -name "*.dmg" -path "*/target/release/bundle/dmg/*" -exec ls -lh {} \; 2>/dev/null || {
            echo "âš ï¸ dmgãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¢ºèªä¸­..."
            find . -type d -name "bundle" -path "*/target/release/*" 2>/dev/null | while read dir; do
              echo "  - $dir"
              ls -la "$dir" 2>/dev/null || true
            done
          }

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
          else
            echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
          fi

      - name: MacOSæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            **/target/release/bundle/dmg/*.dmg
            **/target/release/bundle/dmg/*.dmg.sig
          retention-days: 7

      - name: MacOSç½²åç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          echo "ğŸ§¹ MacOSç½²åç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."

          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’å‰Šé™¤
          security delete-keychain build.keychain 2>/dev/null || true

          # ç’°å¢ƒå¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
          unset APPLE_CERTIFICATE
          unset APPLE_CERTIFICATE_PASSWORD
          unset APPLE_ID
          unset APPLE_ID_PASSWORD
          unset APPLE_TEAM_ID

          echo "âœ… MacOSç½²åç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  # Windowsãƒ“ãƒ«ãƒ‰
  build-windows:
    needs: version-tag
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Rustç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: dtolnay/rust-toolchain@stable

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
        run: pnpm build

      - name: Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: pnpm tauri build
        env:
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒè¨­å®š
          ENVIRONMENT: production
          DEBUG: false
          LOG_LEVEL: info
          # APIã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
          API_SERVER_URL: https://orano-keihi.tsucchinoko.workers.dev
          API_TIMEOUT_SECONDS: 30
          API_MAX_RETRIES: 3
          # Google OAuth 2.0è¨­å®š
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: http://127.0.0.1/callback
          # ã‚»ãƒƒã‚·ãƒ§ãƒ³æš—å·åŒ–ã‚­ãƒ¼
          SESSION_ENCRYPTION_KEY: ${{ secrets.SESSION_ENCRYPTION_KEY }}
          # Windowsç½²åè¨­å®š
          WINDOWS_TIMESTAMP_URL: http://timestamp.digicert.com

      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        run: |
          echo "ğŸ¯ Windowsãƒ“ãƒ«ãƒ‰å®Œäº†"
          echo "ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"

          # msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¤œç´¢
          $msiFiles = Get-ChildItem -Path . -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*target*release*bundle*msi*" }

          if ($msiFiles) {
            foreach ($file in $msiFiles) {
              Write-Host "  - $($file.Name) ($([math]::Round($file.Length/1MB, 2)) MB)"
              Write-Host "    å ´æ‰€: $($file.DirectoryName)"
            }
          } else {
            Write-Host "âš ï¸ msiãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            Write-Host "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¢ºèªä¸­..."
            Get-ChildItem -Path . -Directory -Recurse -Filter "bundle" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
              Get-ChildItem -Path $_.FullName -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "    - $($_.Name)"
              }
            }
          }

          if ("${{ github.event_name }}" -eq "pull_request") {
            echo "âœ… PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº† - ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
          } else {
            echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push - ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
          }
        shell: pwsh

      - name: Windowsæˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            **/target/release/bundle/msi/*.msi
          retention-days: 7

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/release'

    steps:
      - uses: actions/checkout@v4

      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        run: |
          echo "ğŸ”§ Tauriè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."

          # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          export VERSION="${{ needs.version-tag.outputs.VERSION }}"
          export RELEASE_TAG="${{ needs.version-tag.outputs.RELEASE_TAG }}"
          export RELEASE_NOTES="ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ needs.version-tag.outputs.VERSION }} ã®ãƒªãƒªãƒ¼ã‚¹"
          export GITHUB_REPOSITORY="${{ github.repository }}"

          # JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          node script/generate-update-manifest.cjs

          echo "âœ… é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ"

          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:"
          if [ -d "update-manifests" ]; then
            ls -la update-manifests/
          else
            echo "âŒ update-manifestsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const version = '${{ needs.version-tag.outputs.VERSION }}';
            const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
            const commitShort = '${{ needs.version-tag.outputs.COMMIT_SHORT }}';

            console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆé–‹å§‹: ' + releaseTag);

            // æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
            const dmgFiles = fs.readdirSync('./artifacts/macos-artifacts').filter(f => f.endsWith('.dmg'));
            const msiFiles = fs.readdirSync('./artifacts/windows-artifacts').filter(f => f.endsWith('.msi'));

            if (dmgFiles.length === 0 || msiFiles.length === 0) {
              throw new Error('å¿…è¦ãªæˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            const dmgPath = path.join('./artifacts/macos-artifacts', dmgFiles[0]);
            const msiPath = path.join('./artifacts/windows-artifacts', msiFiles[0]);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å–å¾—
            const dmgStats = fs.statSync(dmgPath);
            const msiStats = fs.statSync(msiPath);
            const dmgSizeMB = (dmgStats.size / 1024 / 1024).toFixed(2);
            const msiSizeMB = (msiStats.size / 1024 / 1024).toFixed(2);

            console.log('ğŸ“¦ æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«:');
            console.log('  - MacOS: ' + dmgFiles[0] + ' (' + dmgSizeMB + ' MB)');
            console.log('  - Windows: ' + msiFiles[0] + ' (' + msiSizeMB + ' MB)');

            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
            const releaseNotes = [
              '## ğŸ‰ æ–°ã—ã„ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹: ' + releaseTag,
              '',
              '### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '| ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º |',
              '|---|---|---|',
              '| **MacOS** | ' + dmgFiles[0] + ' | ' + dmgSizeMB + ' MB |',
              '| **Windows** | ' + msiFiles[0] + ' | ' + msiSizeMB + ' MB |',
              '',
              '### ğŸ”„ è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ',
              'ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€Tauriè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ç”¨ã®é™çš„JSONãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š',
              '- `darwin-x86_64.json` - macOS Intelç”¨',
              '- `darwin-aarch64.json` - macOS Apple Siliconç”¨',
              '- `windows-x86_64.json` - Windows 64bitç”¨',
              '',
              'æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯è‡ªå‹•çš„ã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’é€šçŸ¥ã—ã¾ã™ã€‚',
              '',
              '### ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±',
              '- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ' + version,
              '- **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°**: ' + releaseTag,
              '- **ã‚³ãƒŸãƒƒãƒˆ**: ' + context.sha + ' (' + commitShort + ')',
              '- **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (JST)',
              '- **ãƒ“ãƒ«ãƒ‰è€…**: ' + context.actor,
              '',
              '### ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•',
              '',
              '#### MacOS',
              '1. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '2. dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¦ãƒ³ãƒˆ',
              '3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—',
              '',
              '#### Windows',
              '1. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '2. msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€ã‚’é¸æŠ',
              '3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
            ].join('\n');

            // ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
            console.log('ğŸ“ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              name: 'ã‚ªãƒ©ã®çµŒè²»ã ã‚¾ ' + releaseTag,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });

            console.log('âœ… ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ' + release.data.html_url);

            // dmgãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            console.log('ğŸ“¤ MacOS dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            const dmgContent = fs.readFileSync(dmgPath);
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: dmgFiles[0],
              data: dmgContent
            });

            // dmgç½²åãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const sigFiles = fs.readdirSync('./artifacts/macos-artifacts').filter(f => f.endsWith('.dmg.sig'));
            if (sigFiles.length > 0) {
              console.log('ğŸ“¤ MacOSç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
              const sigPath = path.join('./artifacts/macos-artifacts', sigFiles[0]);
              const sigContent = fs.readFileSync(sigPath);
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                name: sigFiles[0],
                data: sigContent
              });
              console.log('âœ… ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ' + sigFiles[0]);
            } else {
              console.warn('âš ï¸  ç½²åãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // msiãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            console.log('ğŸ“¤ Windows msiãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            const msiContent = fs.readFileSync(msiPath);
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: msiFiles[0],
              data: msiContent
            });

            // é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            console.log('ğŸ“¤ é™çš„JSONãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            const manifestDir = './update-manifests';
            if (fs.existsSync(manifestDir)) {
              const manifestFiles = fs.readdirSync(manifestDir).filter(f => f.endsWith('.json'));

              for (const manifestFile of manifestFiles) {
                const manifestPath = path.join(manifestDir, manifestFile);
                const manifestContent = fs.readFileSync(manifestPath);

                console.log('  - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ' + manifestFile);
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: manifestFile,
                  data: manifestContent
                });
              }

              console.log('âœ… ' + manifestFiles.length + 'å€‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            } else {
              console.warn('âš ï¸  ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + manifestDir);
            }

            console.log('ğŸ‰ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼');
            console.log('ğŸ”— ãƒªãƒªãƒ¼ã‚¹URL: ' + release.data.html_url);

  # ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼ï¼ˆPRç”¨ï¼‰
  build-summary:
    needs: [version-tag, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ãƒ“ãƒ«ãƒ‰çµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.version-tag.outputs.VERSION }}';
            const releaseTag = '${{ needs.version-tag.outputs.RELEASE_TAG }}';
            const macosResult = '${{ needs.build-macos.result }}';
            const windowsResult = '${{ needs.build-windows.result }}';
            const eventName = '${{ github.event_name }}';

            console.log('='.repeat(60));
            console.log('ğŸ¯ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰çµæœã‚µãƒãƒªãƒ¼');
            console.log('='.repeat(60));
            console.log('');
            console.log('ğŸ“‹ ãƒ“ãƒ«ãƒ‰æƒ…å ±:');
            console.log('  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ' + version);
            console.log('  - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ' + releaseTag);
            console.log('  - ã‚¤ãƒ™ãƒ³ãƒˆ: ' + eventName);
            console.log('');
            console.log('ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœ:');
            console.log('  - MacOS: ' + (macosResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
            console.log('  - Windows: ' + (windowsResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'));
            console.log('');

            if (eventName === 'pull_request') {
              console.log('ğŸ“ PRç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ:');
              console.log('  âœ… ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
              console.log('  â„¹ï¸  ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ï¼ˆPRç”¨ãƒ†ã‚¹ãƒˆï¼‰');
              console.log('  ğŸ’¡ releaseãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸å¾Œã€è‡ªå‹•çš„ã«ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™');
            } else if (macosResult === 'success' && windowsResult === 'success') {
              console.log('ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ:');
              console.log('  âœ… ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ');
              console.log('  ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ä½œæˆã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã™');
            } else {
              console.log('âš ï¸  ãƒ“ãƒ«ãƒ‰å¤±æ•—:');
              console.log('  âŒ ä¸€éƒ¨ã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“');
            }

            console.log('');
            console.log('='.repeat(60));
